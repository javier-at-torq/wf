apiVersion: torq.io/v2alpha
kind: Workflow
id: a58ef9ba-1906-427a-9235-293145c03aa4
name: RecordedFuture - Domain Enrichment with Cache
trigger:
  onDemandTrigger:
    parameterList:
      parameters:
        - name: domain
          required: true
          prettyName: Domain
          shortText:
            defaultValue: example.com
        - name: recorded_future_integration
          description: The name of the integration with Recorded Future
          required: true
          prettyName: Recorded Future Integration
          integration:
            defaultValue: recordedfuture
            vendor: recorded_future_token
        - name: torq_integration
          description: The name of the integration with Torq
          required: true
          prettyName: Torq Integration
          integration:
            defaultValue: torq
            vendor: torq_token
        - name: provide_raw_analysis_data
          required: true
          prettyName: Provide Raw Analysis Data
          boolean:
            defaultValue: true
    nestedOnly: true
playbook:
  steps:
    - name: us-docker.pkg.dev/stackpulse/public/utils/parameters_utils/workflow_parameters:1.3.0
      id: workflow_parameters
      env:
        SCHEMA: |-
          {
              "cache_ttl": {
                  "type": 11,
                  "prettyName": "Cache TTL",
                  "description": "The cache TTL set in hours to cache IOCs",
                  "uiPlaceholder": "24"
              }
          }
        VALUES: |-
          {
            "cache_ttl": 24
          }
      uuid: 66e433ac-0ea6-4524-91e1-c83d4c2ff150
      pretty_name: Workflow Parameters
      options:
        executor:
          name: utils_workflow_parameters_v_1_3_0
          env: {}
          sync: true
          disable: false
      manifestId: 30ebccc8-0ce8-5f13-960d-bc03b0179f53
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/utils/cryptographic_utils/calculate-sha1:2.0.0
      id: create_sha1_of_observable
      env:
        FILE: '{"source":"{{ $.event.domain }}","type":"default","torq_wrapper__":true}'
      uuid: 4c318d89-9d26-4fe1-a081-151915efdaba
      pretty_name: Create SHA1 of Observable
      options:
        executor:
          name: utils_infrastructure_v_1_12_0
          env:
            COMMAND: calculate_sha1
          sync: true
          disable: false
      manifestId: 3984d107-81b0-5b62-9868-e850cfb2ae77
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/torq/get-a-variable:8.1.0
      id: read_ioc_cache
      env:
        KEY: '{{ $.metadata.workflow_id }}_{{ $.create_sha1_of_observable.result }}'
      envFrom:
        integrationRef: '{{ $.event.torq_integration }}'
      uuid: ae9eb959-59f5-483f-8339-a02a03b4dd6f
      pretty_name: Read IOC Cache
      options:
        executor:
          name: http_request_v_4_6_0
          env:
            AUTHORIZATION: Bearer
            HEADERS: '{}'
            METHOD: GET
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["ACCESS_TOKEN", "KEY"]'
            TIMEOUT: "30"
            TOKEN: '{{ .ACCESS_TOKEN }}'
            URL: https://api.{{ .TORQ_BASE_URL }}/public/v2alpha/variables/{{ .KEY }}
          sync: true
          disable: false
      manifestId: 113df204-5b8d-5be4-8f22-895f9e87a732
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - if:
        conditions:
          or:
            - and:
                - lvalue: '{{ $.read_ioc_cache.api_object.value }}'
                  operator: IS_EMPTY
                  rvalue: ""
        then:
          - name: us-docker.pkg.dev/stackpulse/public/recorded_future/enrich-domain:3.0.1
            id: enrich_domain
            env:
              DOMAIN: '{{ $.event.domain }}'
              RETURN_FIELDS: enterpriseLists,entity,risk,riskMapping,sightings,timestamps
            envFrom:
              integrationRef: '{{ $.event.recorded_future_integration }}'
            ignoreFailure: true
            uuid: 08af44fe-561f-49cf-aef3-da7edba84a4a
            pretty_name: Enrich Domain
            options:
              executor:
                name: http_request_v_4_1_1
                env:
                  HEADERS: |-
                    {
                        "X-RFToken": "{{ .RECORDED_FUTURE_API_TOKEN }}"
                    }
                  METHOD: GET
                  PARSE_HJSON: "true"
                  REQUIRED_VARIABLES: '["RETURN_FIELDS", "DOMAIN", "RECORDED_FUTURE_API_TOKEN"]'
                  TIMEOUT: "30"
                  URL: https://api.recordedfuture.com/v2/domain/{{ .DOMAIN | urlEnc }}?&fields={{ .RETURN_FIELDS | urlEnc }}{{ if or .INCLUDE_METADATA }}&metadata={{ .INCLUDE_METADATA | urlEnc }}{{ end }}
                sync: true
                disable: false
            documentationUrl: https://api.recordedfuture.com/v2/#!/Domain/Domain_Lookup
            manifestId: c84b8773-4a37-4e56-9abf-ac391de0ca21
            isPrivate: false
            skip: false
          - if:
              conditions:
                or:
                  - and:
                      - lvalue: '{{ $.enrich_domain.step_status.code }}'
                        operator: EQUALS
                        rvalue: "1"
              then:
                - parallel:
                    uuid: 262d1c1e-8dcf-4bce-a069-d5b28aeddc53
                    pretty_name: Parallel Executions
                    threads:
                      - uuid: 0120c0e0-9976-4de9-b77b-3866bdb61b4f
                        steps:
                          - if:
                              conditions:
                                or:
                                  - and:
                                      - lvalue: '{{ $.enrich_domain.api_object.data.riskMapping }}'
                                        operator: NOT_EMPTY
                                        rvalue: ""
                              then:
                                - name: us-docker.pkg.dev/stackpulse/public/jq/infra:3.8.0
                                  id: ttps
                                  env:
                                    INPUT: '{{ $.enrich_domain.api_object.data.riskMapping }}'
                                    JSON_QUERY: 'map ( {"rule":.rule, "ttps":(.categories[]|.name) } ) | group_by(.rule) | map({rule: .[0].rule, ttps: map(.ttps)})'
                                  uuid: 45e30d24-74b1-4021-abe3-1640c7d97a3e
                                  pretty_name: ttps
                                  options:
                                    executor:
                                      name: jq_infra_v_3_8_0
                                      env:
                                        COMMAND: jq_command
                                      sync: true
                                      disable: false
                                  documentationUrl: https://stedolan.github.io/jq/manual/#Basicfilters
                                  manifestId: 44e7e0f1-b7c5-5319-bbba-c53a2954c5c3
                                  isPrivate: false
                                  isPrivateUrl: true
                                  mock_output:
                                    enabled: false
                                  skip: false
                              else:
                                - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
                                  id: ttps
                                  env:
                                    DATA_TYPE: JSON
                                    VALUE_JSON: '[]'
                                    VARIABLE_NAME: output
                                  uuid: 306264a3-0bc0-4e7c-803f-8bc583c564a6
                                  pretty_name: ttps
                                  options:
                                    executor:
                                      name: utils_infrastructure_v_1_9_0
                                      env:
                                        COMMAND: set_variable
                                      sync: true
                                      disable: false
                                  manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
                                  isPrivate: false
                                  mock_output:
                                    enabled: false
                                  skip: false
                              uuid: 1c962e7f-4e86-4ec0-b542-2230a472fd86
                              pretty_name: If Risk Mapping Found
                      - uuid: 7d3df9a1-71d2-4561-a290-8a640cfe495b
                        steps:
                          - name: us-docker.pkg.dev/stackpulse/public/utils/string_utils/defang-or-refang-entity:2.0.2
                            id: defang_observable
                            env:
                              DO_NOT_PARSE_AS_FILE: "true"
                              INPUT: '{{ $.event.domain }}'
                              OPERATION: Defang
                            uuid: 4f24a8be-e254-4063-ad23-d87947053354
                            pretty_name: Defang Observable
                            options:
                              executor:
                                name: utils_infrastructure_v_1_9_0
                                env:
                                  COMMAND: defang_or_refang_entity
                                sync: true
                                disable: false
                            manifestId: 1a14dde2-4ea3-5544-9534-1d81cb596c9a
                            isPrivate: false
                            mock_output:
                              enabled: false
                            skip: false
                - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
                  id: enrichment_results
                  env:
                    DATA_TYPE: JSON
                    VALUE_JSON: |-
                      {
                        "raw_data":{{ $.enrich_domain.api_object.data }},
                        "observable_type":"Hostname",
                        "observable_subtype":"FQDN",
                        "observable_value":"{{ $.event.domain }}",
                        "observable_defanged_value":"{{ $.defang_observable.result }}",
                        "observable_description":"{{ $.enrich_domain.api_object.data.risk.riskSummary }}",
                        "observable_reputation": "{{ $.enrich_domain.api_object.data.risk.criticalityLabel }}",
                        "mitre":{{ $.ttps.output }}
                      }
                    VARIABLE_NAME: output
                  uuid: 79ae49a6-3920-4642-9ec3-ae0b672a227d
                  pretty_name: Enrichment Results
                  options:
                    executor:
                      name: utils_infrastructure_v_1_9_0
                      env:
                        COMMAND: set_variable
                      sync: true
                      disable: false
                  manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
                  isPrivate: false
                  mock_output:
                    enabled: false
                  skip: false
                - name: us-docker.pkg.dev/stackpulse/public/torq/set-a-variable:8.1.0
                  id: save_the_ioc_details_to_cache
                  env:
                    EXPIRES_IN: '{{ $.workflow_parameters.cache_ttl }}h'
                    KEY: '{{ $.metadata.workflow_id }}_{{ $.create_sha1_of_observable.result }}'
                    VALUE: '{{ $.enrichment_results.output }}'
                  envFrom:
                    integrationRef: '{{ $.event.torq_integration }}'
                  uuid: 26ecaf71-9643-4379-9436-4bd152bd3044
                  pretty_name: Save the IOC details to Cache
                  options:
                    executor:
                      name: http_request_v_4_6_0
                      env:
                        AUTHORIZATION: Bearer
                        BODY: |-
                          {
                          {{ if or .EXPIRES_IN }}    "expires_in": "{{ .EXPIRES_IN | jsonEscape }}",{{ end }}
                          {{ if or .DO_NOT_RETURN_VALUE }}    "no_print": {{ .DO_NOT_RETURN_VALUE }},{{ end }}
                              "value": {{ .VALUE }}
                          }
                        CONTENT_TYPE: application/json
                        HEADERS: '{}'
                        METHOD: POST
                        PARSE_HJSON: "true"
                        REQUIRED_VARIABLES: '["ACCESS_TOKEN", "KEY", "VALUE"]'
                        TIMEOUT: "30"
                        TOKEN: '{{ .ACCESS_TOKEN }}'
                        URL: https://api.{{ .TORQ_BASE_URL }}/public/v2alpha/variables/{{ .KEY }}
                      sync: true
                      disable: false
                  manifestId: 0cd7861c-160a-5b92-9293-28d09953c01f
                  isPrivate: false
                  mock_output:
                    enabled: false
                  skip: false
              else:
                - exit:
                    success: "true"
                    pretty_name: Exit
                    output: |-
                      {
                        "output": {
                          "observable_value": "{{ $.event.domain }}",
                          "observable_reputation": "Not Found"
                        }
                      }
                    uuid: 493d1131-29f4-42e5-a993-3c04d18c7f93
                    use_schema: true
              uuid: 584a95fb-d164-465c-af65-1efacd408efe
              pretty_name: If RecordedFuture Analysis Exists
        else:
          - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
            id: enrichment_results
            env:
              DATA_TYPE: JSON
              VALUE_JSON: '{{ $.read_ioc_cache.api_object.value }}'
              VARIABLE_NAME: output
            uuid: 7f57dd98-5ed9-4599-a54f-1560c1377102
            pretty_name: Enrichment Results
            options:
              executor:
                name: utils_infrastructure_v_1_9_0
                env:
                  COMMAND: set_variable
                sync: true
                disable: false
            manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
            isPrivate: false
            mock_output:
              enabled: false
            skip: false
        uuid: a2fb6135-3fdb-4b1a-8d92-922abac995ad
        pretty_name: If IOC Cache is Empty
    - if:
        conditions:
          or:
            - and:
                - lvalue: '{{ $.event.provide_raw_analysis_data }}'
                  operator: EQUALS
                  rvalue: "true"
        then: []
        else:
          - name: us-docker.pkg.dev/stackpulse/public/jq/infra:3.8.0
            id: enrichment_results
            env:
              INPUT: '{{ $.enrichment_results.output }}'
              JSON_QUERY: del(.raw_data)
            uuid: 4b819871-f1b5-4a30-b841-ed27ca843675
            pretty_name: Enrichment Results
            options:
              executor:
                name: jq_infra_v_3_8_0
                env:
                  COMMAND: jq_command
                sync: true
                disable: false
            documentationUrl: https://stedolan.github.io/jq/manual/#Basicfilters
            manifestId: 44e7e0f1-b7c5-5319-bbba-c53a2954c5c3
            isPrivate: false
            isPrivateUrl: true
            mock_output:
              enabled: false
            skip: false
        uuid: 3601aa85-d32d-4ca8-bee3-7defe4eabdb8
        pretty_name: If Add Raw Analysis
    - exit:
        success: "true"
        pretty_name: Exit
        output: |-
          {
            "output": {{ $.enrichment_results.output }}
          }
        uuid: ecc8f92e-0223-4ac7-af49-846fe87c4add
        use_schema: true
  annotations:
    - uuid: efca92f8-fb2a-4a84-98a7-b3dfc32d3d25
      x: -610
      "y": 124
      width: 467
      height: 319
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"RecordedFuture - Domain Enrichment"}]},{"type":"paragraph","content":[{"type":"hardBreak"},{"type":"text","text":"Receive a domain from a parent workflow and query Recorded Future for its reputation."}]},{"type":"paragraph","content":[{"type":"text","text":"This workflow utilizes a global variable as a cache to temporarily store results and actively queries for enrichment only when the observable reputation is not found in the local cache."}]},{"type":"paragraph","content":[{"type":"image","attrs":{"src":"https://images.g2crowd.com/uploads/product/image/social_landscape/social_landscape_9d79dbf9c1e656238aabcb6f6593e8b9/recorded-future.png","alt":null,"title":null}}]}]}'
    - uuid: b31796c9-2538-4138-8631-3c0cf2f513d4
      x: -179
      "y": 858
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Cached Results"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"By default results are cached 24 hrs."}]},{"type":"paragraph","content":[{"type":"text","text":"If reputation is found stored in a global value, then the cached result is returned to the parent workflow."}]}]}'
    - uuid: 76a975ed-d39a-4050-a210-3704e747ecf4
      x: 344
      "y": 205
      width: 426
      height: 151
      attachedStepId: 66e433ac-0ea6-4524-91e1-c83d4c2ff150
      attachedDistance:
        x: -344
        "y": -74
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Cache TTL"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"Set expiration time for local cache on "},{"type":"text","marks":[{"type":"code"}],"text":"Cache TTL"},{"type":"text","text":" variable"}]}]}'
    - uuid: de6c66b1-915d-4dd4-bca7-b24f141e8535
      x: 1157
      "y": 1690
      width: 420
      height: 253
      attachedStepId: 79ae49a6-3920-4642-9ec3-ae0b672a227d
      attachedDistance:
        x: -317
        "y": -92
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Results Summary"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"Output provides a summarized version of the analysis, although the original analysis information is available as optional."},{"type":"hardBreak"},{"type":"hardBreak"},{"type":"text","text":"All data is stored on local cache using the "},{"type":"text","marks":[{"type":"code"}],"text":"workflow_id"},{"type":"text","text":" and the "},{"type":"text","marks":[{"type":"code"}],"text":"hash of the observable"},{"type":"text","text":" value as the key for retrieve it later."}]}]}'
    - uuid: 26c994bb-75d9-415d-963b-844cb6be8c9e
      x: 341
      "y": 2293
      width: 518
      height: 235
      attachedStepId: 4b819871-f1b5-4a30-b841-ed27ca843675
      attachedDistance:
        x: -481
        "y": -53
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Provide Original Analysis Output"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"When Provide "},{"type":"text","marks":[{"type":"code"}],"text":"Raw Analysis Data"},{"type":"text","text":" parameter is set to "},{"type":"text","marks":[{"type":"code"}],"text":"false"},{"type":"text","text":". Original JSON object returned by vendor API is deleted from output."}]},{"type":"paragraph","content":[{"type":"text","text":"When "},{"type":"text","marks":[{"type":"code"}],"text":"Provide Raw Analysis Data"},{"type":"text","text":" parameter is set to "},{"type":"text","marks":[{"type":"code"}],"text":"true"},{"type":"text","text":". Both, original API Response and Workflows Summary are returned to parent workflow."}]}]}'
  output_schema: |-
    {
        "output": {
            "type": 10,
            "prettyName": "output",
            "description": ""
        }
    }
root: true
