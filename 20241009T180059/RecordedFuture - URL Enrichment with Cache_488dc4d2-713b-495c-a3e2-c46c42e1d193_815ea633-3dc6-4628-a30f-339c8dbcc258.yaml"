!!ExportedWorkflow
apiVersion: torq.io/v2alpha
kind: Workflow
id: 488dc4d2-713b-495c-a3e2-c46c42e1d193
name: RecordedFuture - URL Enrichment with Cache
trigger:
  onDemandTrigger:
    parameterList:
      parameters:
        - name: url
          required: true
          prettyName: URL
          shortText:
            defaultValue: http://www.example.com
        - name: recorded_future_integration
          description: The name of the integration with Recorded Future
          required: true
          prettyName: Recorded Future Integration
          integration:
            defaultValue: recordedfuture
            vendor: recorded_future_token
        - name: torq_integration
          description: The name of the integration with Torq
          required: true
          prettyName: Torq Integration
          integration:
            defaultValue: torq
            vendor: torq_token
        - name: provide_raw_analysis_data
          required: true
          prettyName: Provide Raw Analysis Data
          boolean:
            defaultValue: true
    nestedOnly: true
playbook:
  steps:
    - name: us-docker.pkg.dev/stackpulse/public/utils/parameters_utils/workflow_parameters:1.3.0
      id: workflow_parameters
      env:
        SCHEMA: |-
          {
              "cache_ttl": {
                  "type": 11,
                  "prettyName": "Cache TTL",
                  "description": "The cache TTL set in hours to cache IOCs",
                  "uiPlaceholder": "24"
              }
          }
        VALUES: |-
          {
            "cache_ttl": 24
          }
      uuid: 66e433ac-0ea6-4524-91e1-c83d4c2ff150
      pretty_name: Workflow Parameters
      options:
        executor:
          name: utils_workflow_parameters_v_1_3_0
          env: {}
          sync: true
          disable: false
      manifestId: 30ebccc8-0ce8-5f13-960d-bc03b0179f53
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/utils/cryptographic_utils/calculate-sha1:2.0.0
      id: create_sha1_of_observable
      env:
        FILE: '{"source":"{{ b64enc $.event.url }}","type":"default","torq_wrapper__":true}'
      uuid: 4c318d89-9d26-4fe1-a081-151915efdaba
      pretty_name: Create SHA1 of Observable
      options:
        executor:
          name: utils_infrastructure_v_1_12_0
          env:
            COMMAND: calculate_sha1
          sync: true
          disable: false
      manifestId: 3984d107-81b0-5b62-9868-e850cfb2ae77
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/torq/get-a-variable:8.1.0
      id: read_ioc_cache
      env:
        KEY: '{{ $.metadata.workflow_id }}_{{ $.create_sha1_of_observable.result }}'
      envFrom:
        integrationRef: '{{ $.event.torq_integration }}'
      uuid: ae9eb959-59f5-483f-8339-a02a03b4dd6f
      pretty_name: Read IOC Cache
      options:
        executor:
          name: http_request_v_4_6_0
          env:
            AUTHORIZATION: Bearer
            HEADERS: '{}'
            METHOD: GET
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["ACCESS_TOKEN", "KEY"]'
            TIMEOUT: "30"
            TOKEN: '{{ .ACCESS_TOKEN }}'
            URL: https://api.{{ .TORQ_BASE_URL }}/public/v2alpha/variables/{{ .KEY }}
          sync: true
          disable: false
      manifestId: 113df204-5b8d-5be4-8f22-895f9e87a732
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - if:
        conditions:
          or:
            - and:
                - lvalue: '{{ $.read_ioc_cache.api_object.value }}'
                  operator: IS_EMPTY
                  rvalue: ""
        then:
          - name: us-docker.pkg.dev/stackpulse/public/recorded_future/enrich-url:3.0.4
            id: enrich_url
            env:
              RETURN_FIELDS: enterpriseLists,entity,risk,riskMapping,sightings,timestamps
              URL_ADDRESS: '{{ $.event.url }}'
            envFrom:
              integrationRef: '{{ $.event.recorded_future_integration }}'
            ignoreFailure: true
            uuid: 28035754-b061-42c3-a0a4-aba9097dbb7d
            pretty_name: Enrich URL
            options:
              executor:
                name: http_request_v_4_2_8
                env:
                  HEADERS: |-
                    {
                        "X-RFToken": "{{ .RECORDED_FUTURE_API_TOKEN }}"
                    }
                  METHOD: GET
                  PARSE_HJSON: "true"
                  REQUIRED_VARIABLES: '["RETURN_FIELDS", "URL_ADDRESS", "RECORDED_FUTURE_API_TOKEN"]'
                  TIMEOUT: "30"
                  URL: https://api.recordedfuture.com/v2/url/{{ .URL_ADDRESS | urlEnc }}?&fields={{ .RETURN_FIELDS | urlEnc }}{{ if or .INCLUDE_METADATA }}&metadata={{ .INCLUDE_METADATA | urlEnc }}{{ end }}
                sync: true
                disable: false
            documentationUrl: https://api.recordedfuture.com/v2/#!/URL/URL_Lookup
            manifestId: f0179268-d8e1-4227-8bb0-cfbf03903740
            isPrivate: false
            mock_output:
              enabled: false
            skip: false
          - if:
              conditions:
                or:
                  - and:
                      - lvalue: '{{ $.enrich_url.step_status.code }}'
                        operator: EQUALS
                        rvalue: "1"
              then:
                - parallel:
                    uuid: 65f3a115-4ab9-40a5-8a9b-ab3ac97b1ecd
                    pretty_name: Parallel Executions
                    threads:
                      - uuid: f3510d16-9434-495f-b5b6-ad50272c52da
                        steps:
                          - if:
                              conditions:
                                or:
                                  - and:
                                      - lvalue: '{{ $.enrich_url.api_object.data.riskMapping }}'
                                        operator: NOT_EMPTY
                                        rvalue: ""
                              then:
                                - name: us-docker.pkg.dev/stackpulse/public/jq/infra:3.9.0
                                  id: ttps
                                  env:
                                    INPUT: '{{ $.enrich_url.api_object.data.riskMapping }}'
                                    JSON_QUERY: 'map ( {"rule":.rule, "ttps":(.categories[]|.name) } ) | group_by(.rule) | map({rule: .[0].rule, ttps: map(.ttps)})'
                                  uuid: 5d56b618-9534-4cb4-99f8-1305533926f7
                                  pretty_name: ttps
                                  options:
                                    executor:
                                      name: jq_infra_v_3_9_0
                                      env:
                                        COMMAND: jq_command
                                      sync: true
                                      disable: false
                                  documentationUrl: https://stedolan.github.io/jq/manual/#Basicfilters
                                  manifestId: eff9788e-be58-533f-9dde-3703babc5128
                                  isPrivate: false
                                  isPrivateUrl: true
                                  mock_output:
                                    enabled: false
                                  skip: false
                              else:
                                - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
                                  id: ttps
                                  env:
                                    DATA_TYPE: JSON
                                    VALUE_JSON: '[]'
                                    VARIABLE_NAME: output
                                  uuid: 1d8a92f3-c8c1-48af-ba46-135d940312b7
                                  pretty_name: ttps
                                  options:
                                    executor:
                                      name: utils_infrastructure_v_1_9_0
                                      env:
                                        COMMAND: set_variable
                                      sync: true
                                      disable: false
                                  manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
                                  isPrivate: false
                                  mock_output:
                                    enabled: false
                                  skip: false
                              uuid: 4682261a-a98a-4004-876a-8cec5917d7e9
                              pretty_name: If Risk Mapping Found
                      - uuid: a733eac2-e397-4d2c-8949-1e230ba18991
                        steps:
                          - name: us-docker.pkg.dev/stackpulse/public/utils/string_utils/defang-or-refang-entity:2.0.2
                            id: defang_observable
                            env:
                              DO_NOT_PARSE_AS_FILE: "true"
                              INPUT: '{{ $.event.url }}'
                              OPERATION: Defang
                            uuid: 41e6e021-e6d7-4355-ab08-996567c610e3
                            pretty_name: Defang Observable
                            options:
                              executor:
                                name: utils_infrastructure_v_1_9_0
                                env:
                                  COMMAND: defang_or_refang_entity
                                sync: true
                                disable: false
                            manifestId: 1a14dde2-4ea3-5544-9534-1d81cb596c9a
                            isPrivate: false
                            mock_output:
                              enabled: false
                            skip: false
                - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
                  id: enrichment_results
                  env:
                    DATA_TYPE: JSON
                    VALUE_JSON: |-
                      {
                        "raw_data":{{ $.enrich_url.api_object.data }},
                        "observable_value":"{{ $.event.url }}",
                        "observable_defanged_value":"{{ $.defang_observable.result }}",
                        "observable_type":"{{ $.enrich_url.api_object.data.entity.type }}",
                        "observable_description":"{{ $.enrich_url.api_object.data.risk.riskSummary }}",
                        "observable_reputation": "{{ $.enrich_url.api_object.data.risk.criticalityLabel }}",
                        "mitre":{{ $.ttps.output }}
                      }
                    VARIABLE_NAME: output
                  uuid: 2e347504-0fdc-47b0-a87f-5276ebf6cb42
                  pretty_name: Enrichment Results
                  options:
                    executor:
                      name: utils_infrastructure_v_1_9_0
                      env:
                        COMMAND: set_variable
                      sync: true
                      disable: false
                  manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
                  isPrivate: false
                  mock_output:
                    enabled: false
                  skip: false
                - name: us-docker.pkg.dev/stackpulse/public/torq/set-a-variable:8.1.0
                  id: save_the_ioc_details_to_cache
                  env:
                    EXPIRES_IN: '{{ $.workflow_parameters.cache_ttl }}h'
                    KEY: '{{ $.metadata.workflow_id }}_{{ $.create_sha1_of_observable.result }}'
                    VALUE: '{{ $.enrichment_results.output }}'
                  envFrom:
                    integrationRef: '{{ $.event.torq_integration }}'
                  uuid: 26ecaf71-9643-4379-9436-4bd152bd3044
                  pretty_name: Save the IOC Details to Cache
                  options:
                    executor:
                      name: http_request_v_4_6_0
                      env:
                        AUTHORIZATION: Bearer
                        BODY: |-
                          {
                          {{ if or .EXPIRES_IN }}    "expires_in": "{{ .EXPIRES_IN | jsonEscape }}",{{ end }}
                          {{ if or .DO_NOT_RETURN_VALUE }}    "no_print": {{ .DO_NOT_RETURN_VALUE }},{{ end }}
                              "value": {{ .VALUE }}
                          }
                        CONTENT_TYPE: application/json
                        HEADERS: '{}'
                        METHOD: POST
                        PARSE_HJSON: "true"
                        REQUIRED_VARIABLES: '["ACCESS_TOKEN", "KEY", "VALUE"]'
                        TIMEOUT: "30"
                        TOKEN: '{{ .ACCESS_TOKEN }}'
                        URL: https://api.{{ .TORQ_BASE_URL }}/public/v2alpha/variables/{{ .KEY }}
                      sync: true
                      disable: false
                  manifestId: 0cd7861c-160a-5b92-9293-28d09953c01f
                  isPrivate: false
                  mock_output:
                    enabled: false
                  skip: false
              else:
                - exit:
                    success: "true"
                    pretty_name: Exit
                    output: |-
                      {
                        "output": {
                          "observable_value": "{{ $.event.url }}",
                          "observable_reputation": "Not Found"
                        }
                      }
                    uuid: 493d1131-29f4-42e5-a993-3c04d18c7f93
                    use_schema: true
              uuid: 584a95fb-d164-465c-af65-1efacd408efe
              pretty_name: If RecordedFuture Analysis Exists
        else:
          - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
            id: enrichment_results
            env:
              DATA_TYPE: JSON
              VALUE_JSON: '{{ $.read_ioc_cache.api_object.value }}'
              VARIABLE_NAME: output
            uuid: 5f8abc9c-c570-4c8e-b12a-88be1fd1c165
            pretty_name: Enrichment Results
            options:
              executor:
                name: utils_infrastructure_v_1_9_0
                env:
                  COMMAND: set_variable
                sync: true
                disable: false
            manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
            isPrivate: false
            mock_output:
              enabled: false
            skip: false
        uuid: a2fb6135-3fdb-4b1a-8d92-922abac995ad
        pretty_name: If IOC Cache is Empty
    - if:
        conditions:
          or:
            - and:
                - lvalue: '{{ $.event.provide_raw_analysis_data }}'
                  operator: EQUALS
                  rvalue: "true"
        then: []
        else:
          - name: us-docker.pkg.dev/stackpulse/public/jq/infra:3.9.0
            id: enrichment_results
            env:
              INPUT: '{{ $.enrichment_results.output }}'
              JSON_QUERY: del(.raw_data)
            uuid: e1e5db9b-02e2-4165-add1-f329b95a01ec
            pretty_name: Enrichment Results
            options:
              executor:
                name: jq_infra_v_3_9_0
                env:
                  COMMAND: jq_command
                sync: true
                disable: false
            documentationUrl: https://stedolan.github.io/jq/manual/#Basicfilters
            manifestId: eff9788e-be58-533f-9dde-3703babc5128
            isPrivate: false
            isPrivateUrl: true
            mock_output:
              enabled: false
            skip: false
        uuid: bdaea9bc-c2c3-41a7-95e3-d19a9d1aeb30
        pretty_name: If Add Raw Analysis
    - exit:
        success: "true"
        pretty_name: Exit
        output: |-
          {
            "output": {{ $.enrichment_results.output }}
          }
        uuid: ecc8f92e-0223-4ac7-af49-846fe87c4add
        use_schema: true
  annotations:
    - uuid: efca92f8-fb2a-4a84-98a7-b3dfc32d3d25
      x: -608
      "y": 120
      width: 467
      height: 319
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"RecordedFuture -  URL Enrichment"}]},{"type":"paragraph","content":[{"type":"hardBreak"},{"type":"text","text":"Receive an URL from a parent workflow and query Recorded Future for its reputation."}]},{"type":"paragraph","content":[{"type":"text","text":"This workflow utilizes a global variable as a cache to temporarily store results and actively queries for enrichment only when the observable reputation is not found in the local cache."}]},{"type":"paragraph","content":[{"type":"image","attrs":{"src":"https://images.g2crowd.com/uploads/product/image/social_landscape/social_landscape_9d79dbf9c1e656238aabcb6f6593e8b9/recorded-future.png","alt":null,"title":null}}]}]}'
    - uuid: f0fece33-e2c4-4a2b-9b2c-d5c93f4cf2bb
      x: -178
      "y": 856
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Cached Results"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"By default results are cached 24 hrs."}]},{"type":"paragraph","content":[{"type":"text","text":"If reputation is found stored in a global value, then the cached result is returned to the parent workflow."}]}]}'
    - uuid: fc524739-7eb5-4510-981d-080ffa724464
      x: 336
      "y": 201
      width: 452
      height: 151
      attachedStepId: 66e433ac-0ea6-4524-91e1-c83d4c2ff150
      attachedDistance:
        x: -336
        "y": -70
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Cache TTL"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"Set expiration time for local cache on "},{"type":"text","marks":[{"type":"code"}],"text":"Cache TTL"},{"type":"text","text":" variable"}]}]}'
    - uuid: b9376912-a070-4c0b-854e-79ff572569a1
      x: 1164
      "y": 1692
      width: 418
      height: 253
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Results Summary"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"Output provides a summarized version of the analysis, although the original analysis information is available as optional."},{"type":"hardBreak"},{"type":"hardBreak"},{"type":"text","text":"All data is stored on local cache using the "},{"type":"text","marks":[{"type":"code"}],"text":"workflow_id"},{"type":"text","text":" and the "},{"type":"text","marks":[{"type":"code"}],"text":"hash of the observable"},{"type":"text","text":" value as the key for retrieve it later."}]}]}'
    - uuid: c3cf003d-1830-46da-9296-8c0af0c88cfa
      x: 342
      "y": 2298
      width: 520
      height: 235
      attachedStepId: e1e5db9b-02e2-4165-add1-f329b95a01ec
      attachedDistance:
        x: -482
        "y": -58
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Provide Original Analysis Output"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"When Provide "},{"type":"text","marks":[{"type":"code"}],"text":"Raw Analysis Data"},{"type":"text","text":" parameter is set to "},{"type":"text","marks":[{"type":"code"}],"text":"false"},{"type":"text","text":". Original JSON object returned by vendor API is deleted from output."}]},{"type":"paragraph","content":[{"type":"text","text":"When "},{"type":"text","marks":[{"type":"code"}],"text":"Provide Raw Analysis Data"},{"type":"text","text":" parameter is set to "},{"type":"text","marks":[{"type":"code"}],"text":"true"},{"type":"text","text":". Both, original API Response and Workflows Summary are returned to parent workflow."}]}]}'
  output_schema: |-
    {
        "output": {
            "type": 10,
            "prettyName": "output",
            "description": ""
        }
    }
root: true
