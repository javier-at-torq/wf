apiVersion: torq.io/v2alpha
kind: Workflow
id: 54c0808e-1323-4355-a530-909db288fcbf
name: Outlook Toolkit
trigger:
  onDemandTrigger:
    parameterList:
      parameters:
        - name: action
          description: The name of the action to execute in this workflow
          required: true
          prettyName: action
          singleSelect:
            options:
              - quarantine
              - help
              - fetch_message
            defaultValue: ""
        - name: message_id
          description: The id of an message in outlook
          prettyName: message_id
          shortText:
            defaultValue: ""
playbook:
  steps:
    - name: us-docker.pkg.dev/stackpulse/public/utils/parameters_utils/workflow_parameters:1.3.0
      id: workflow_parameters
      env:
        SCHEMA: |-
          {
              "service_mailbox": {
                  "type": 8,
                  "prettyName": "service_mailbox",
                  "description": "",
                  "uiPlaceholder": ""
              },
              "case_id": {
                  "type": 8,
                  "prettyName": "case_id",
                  "description": "",
                  "uiPlaceholder": ""
              }
          }
        VALUES: |-
          {
            "service_mailbox": "phishing@tl.torqlab.net",
            "case_id": "{{ $.metadata.case.id }}"
          }
      uuid: ebdf02ae-a233-4174-a661-2272038934b1
      pretty_name: Workflow Parameters
      options:
        executor:
          name: utils_workflow_parameters_v_1_3_0
          env: {}
          sync: true
          disable: false
      manifestId: 30ebccc8-0ce8-5f13-960d-bc03b0179f53
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
      retry: {}
    - name: us-docker.pkg.dev/stackpulse/public/microsoft_365/generate-access-token:2.0.3
      id: generate_access_token
      envFrom:
        integrationRef: microsoft_365
      uuid: d0825f27-baa2-4a1d-97bb-45a6358c3abf
      pretty_name: Generate Access Token
      options:
        executor:
          name: http_request_v_4_2_3
          env:
            BODY: '[{"key": "client_id", "type": "text", "value": "{{ .MICROSOFT_365_CLIENT_ID | jsonEscape }}", "should_exists_var": "MICROSOFT_365_CLIENT_ID"}, {"key": "scope", "type": "text", "value": "https://graph.microsoft.com/.default"}, {"key": "client_secret", "type": "text", "value": "{{ .MICROSOFT_365_CLIENT_SECRET | jsonEscape }}", "should_exists_var": "MICROSOFT_365_CLIENT_SECRET"}, {"key": "grant_type", "type": "text", "value": "client_credentials"}]'
            CONTENT_TYPE: application/x-www-form-urlencoded
            HEADERS: |-
              {
                  "Content-Type": "application/x-www-form-urlencoded"
              }
            METHOD: POST
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["MICROSOFT_365_TENANT_ID", "MICROSOFT_365_CLIENT_ID", "MICROSOFT_365_CLIENT_SECRET"]'
            TIMEOUT: "30"
            URL: https://login.microsoftonline.com/{{ .MICROSOFT_365_TENANT_ID | urlEnc }}/oauth2/v2.0/token
          sync: true
          disable: false
      manifestId: 94deb564-a701-47a1-8cc2-8460f8bf7803
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - switch:
        uuid: b0673499-ee56-4deb-803e-2f568095e6e3
        pretty_name: Switch
        cases:
          - id: b65102cb-001f-4bd7-bb05-c3194e37c2e4
            pretty_name: Fect Message
            conditions:
              or:
                - and:
                    - lvalue: '{{ $.event.action }}'
                      operator: EQUALS
                      rvalue: fetch_message
            steps:
              - name: us-docker.pkg.dev/stackpulse/public/microsoft_outlook/get-message:5.2.0
                id: get_message
                env:
                  MESSAGE_ID: '{{ $.event.message_id }}'
                  MICROSOFT_ACCESS_TOKEN: '{{ $.generate_access_token.api_object.access_token }}'
                  USER_ID_OR_EMAIL: '{{ $.workflow_parameters.service_mailbox }}'
                uuid: 59032bbb-d419-4a7b-bbb7-b7c699782fe0
                pretty_name: Get Message
                options:
                  executor:
                    name: http_request_v_4_13_0
                    env:
                      AUTHORIZATION: Bearer
                      BODY: ""
                      CONTENT_TYPE: application/json; charset=utf-8
                      FAIL_ON_NON_SUCCESS_RESPONSE: "true"
                      GO_TEMPLATE_BODY_PARSING: "true"
                      HEADERS: |-
                        {
                        {{ if .BODY_CONTENT_TYPE }}  "Prefer": "outlook.body-content-type=\"{{ .BODY_CONTENT_TYPE | jsonEscape }}\""{{ end }}
                        }
                      METHOD: GET
                      PARSE_HJSON: "true"
                      REQUIRED_VARIABLES: '["MICROSOFT_ACCESS_TOKEN", "USER_ID_OR_EMAIL", "MESSAGE_ID"]'
                      RESPONSE_API_OBJECT_ONLY: "true"
                      TIMEOUT: "30"
                      TOKEN: '{{ .MICROSOFT_ACCESS_TOKEN }}'
                      URL: https://graph.microsoft.com/v1.0/users/{{ .USER_ID_OR_EMAIL | urlEnc }}/messages/{{ .MESSAGE_ID | urlEnc }}?{{ if .SKIP }}&$skip={{ .SKIP | urlEnc }}{{ end }}{{ if .PAGE_SIZE }}&$top={{ .PAGE_SIZE | urlEnc }}{{ end }}
                    sync: true
                    disable: false
                documentationUrl: https://docs.microsoft.com/en-us/graph/api/message-get?view=graph-rest-1.0&tabs=http
                manifestId: dc069f85-f0df-58f9-9448-ab2e38a3be03
                isPrivate: false
                mock_output:
                  enabled: false
                skip: false
              - trigger:
                  id: gather_outlook_message_attachments_headers_and_urls
                  playbook_id: 41d3c819-64bf-416f-a095-e3ce0e75e9fd
                  pretty_name: Gather Outlook Message Attachments, Headers, and URLs
                  uuid: be297642-a9e8-4f36-9f35-43ecd23bf2d6
                  input: |-
                    {
                      "message_value": {{ $.get_message.api_object }},
                      "user_id": "{{ $.workflow_parameters.service_mailbox }}",
                      "microsoft365_integration_name": "microsoft_365"
                    }
                  playbook_name: Gather Outlook Message Attachments, Headers, and URLs
                  mock_output:
                    enabled: false
                    payload: '{}'
              - name: us-docker.pkg.dev/stackpulse/public/jq/infra:3.13.0
                id: message
                env:
                  __TQ_FILE_ENV_PARSER__INPUT: plain-text
                  INPUT: '{{ $.gather_outlook_message_attachments_headers_and_urls }}'
                  JSON_QUERY: del(.step_status)
                uuid: 89e1ea38-c09a-4542-a563-939aa78d35dd
                pretty_name: Message
                options:
                  executor:
                    name: jq_infra_v_3_13_0
                    env:
                      COMMAND: jq_command
                    sync: true
                    disable: false
                documentationUrl: https://stedolan.github.io/jq/manual/#Basicfilters
                manifestId: 54f591ea-6fd7-5be5-9392-87c5e0b20bab
                isPrivate: false
                isPrivateUrl: true
                mock_output:
                  enabled: false
                skip: false
                retry: {}
              - if:
                  conditions:
                    or:
                      - and:
                          - lvalue: '{{ $.gather_outlook_message_attachments_headers_and_urls.file_hashes }}'
                            operator: NOT_EMPTY
                            rvalue: ""
                  then:
                    - loop:
                        in: '{{ $.gather_outlook_message_attachments_headers_and_urls.file_hashes }}'
                        key: loop_key
                        value: loop_value
                        steps:
                          - name: us-docker.pkg.dev/stackpulse/public/torq_cases/add-attachment:3.8.0
                            id: add_attachment
                            env:
                              CASE_ID: '{{ $.workflow_parameters.case_id }}'
                              CONTENT_TYPE: '{{ $.loop_value.content_type }}'
                              FILE: '{{ file $.loop_value.url }}'
                              FILE_NAME: '{{ $.loop_value.name }}'
                              INPUT_TYPE: file
                            uuid: 84ed7735-6d41-47a6-8cf1-dd6b1a8bbd41
                            pretty_name: Add Attachment
                            options:
                              executor:
                                name: torq_cases_add-attachment_v_3_8_0
                                env: {}
                                sync: true
                                disable: false
                            manifestId: 01d86597-fbef-5789-ada6-166988660780
                            isPrivate: false
                            mock_output:
                              enabled: false
                            skip: false
                            retry: {}
                        uuid: a8506e0d-8440-4bf4-9d94-91d068c8ee86
                        pretty_name: Loop
                  else: []
                  uuid: 1ea57ab6-4933-41b3-9ef3-0fc4c06ce278
                  pretty_name: If There are attachments
              - exit:
                  success: "true"
                  pretty_name: Exit
                  output: |-
                    {
                      "result": {{ $.message.output }}
                    }
                  uuid: 36e053bb-d0c8-48c3-ba01-a3f98e1b97b8
                  use_schema: true
          - id: 2edde8de-83f6-421f-a9a6-aa3f100f8aae
            pretty_name: Help
            conditions:
              or:
                - and:
                    - lvalue: '{{ $.event.action }}'
                      operator: EQUALS
                      rvalue: help
            steps:
              - name: us-docker.pkg.dev/stackpulse/public/slack/message/message:2.1.0
                id: send_message_4
                env:
                  MESSAGE_TEXT: |-
                    Help!
                    {{ $.event }}
                  RECIPIENT: devnull
                envFrom:
                  integrationRef: wolken
                uuid: 90f31566-098c-456b-b449-869866d10e12
                pretty_name: Send Message 4
                options:
                  executor:
                    name: slack_message_message_v_2_1_0
                    env: {}
                    sync: true
                    disable: false
                manifestId: 111abb4b-15cf-5065-8775-2f2662132e88
                isPrivate: false
                mock_output:
                  enabled: false
                skip: true
                retry: {}
              - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.2.0
                id: help
                env:
                  DATA_TYPE: string
                  VALUE_STRING: "This workflows provides functions relevant to run automations on Microsoft Outlook 365 Email product.\n\nUse the action parameter to choose between: \na) 'fetch_message'\n\n- Use 'fetch_message': to retrieve the details of an email such as body, headers, attachments or URLs.\n"
                  VARIABLE_NAME: help
                uuid: 82a139bb-3ad2-482f-aa68-9c949f87644a
                pretty_name: Help
                options:
                  executor:
                    name: utils_infrastructure_v_1_22_0
                    env:
                      COMMAND: set_variable
                    sync: true
                    disable: false
                manifestId: e430703a-6b6f-5114-9368-5e3fc166edb7
                isPrivate: false
                mock_output:
                  enabled: false
                skip: false
                retry: {}
              - exit:
                  success: "true"
                  pretty_name: Exit
                  output: |-
                    {
                      "result": "{{ jsonEscape $.help.help }}"
                    }
                  uuid: 12572af3-f1a3-4a32-80ab-a223d03bef52
                  use_schema: true
        default:
          id: ca7b4117-36f2-456b-a636-1afca1b1b494
          steps:
            - name: us-docker.pkg.dev/stackpulse/public/slack/message/message:2.1.0
              id: send_message_3
              env:
                MESSAGE_TEXT: |-
                  No valid Action
                  {{ $.event }}
                RECIPIENT: devnull
              envFrom:
                integrationRef: wolken
              uuid: 35939230-4103-4fda-a281-d32f04b805e8
              pretty_name: Send Message 3
              options:
                executor:
                  name: slack_message_message_v_2_1_0
                  env: {}
                  sync: true
                  disable: false
              manifestId: 111abb4b-15cf-5065-8775-2f2662132e88
              isPrivate: false
              mock_output:
                enabled: false
              skip: true
              retry: {}
            - exit:
                success: "true"
                pretty_name: Exit
                output: |-
                  {
                    "result": "It looks like action {{ $.event.action }} is not implemented yet. "
                  }
                uuid: 44c95c71-b8f3-48f1-ac05-901b0b1509ce
                use_schema: true
  output_schema: |-
    {
        "result": {
            "type": 10,
            "prettyName": "result",
            "description": ""
        }
    }
root: true
