apiVersion: torq.io/v2alpha
kind: Workflow
id: 410ccb60-a06b-467b-8d4a-bbfc703a0f01
name: RecordedFuture - File Hash Enrichment with Cache
trigger:
  onDemandTrigger:
    parameterList:
      parameters:
        - name: file_hash
          required: true
          prettyName: File Hash
          shortText:
            defaultValue: ""
        - name: recorded_future_integration
          description: The name of the integration with Recorded Future
          required: true
          prettyName: Recorded Future Integration
          integration:
            defaultValue: recordedfuture
            vendor: recorded_future_token
        - name: torq_integration
          description: The name of the integration with Torq
          required: true
          prettyName: Torq Integration
          integration:
            defaultValue: torq
            vendor: torq_token
        - name: provide_raw_analysis_data
          required: true
          prettyName: Provide Raw Analysis Data
          boolean:
            defaultValue: true
    nestedOnly: true
playbook:
  steps:
    - name: us-docker.pkg.dev/stackpulse/public/utils/parameters_utils/workflow_parameters:1.3.0
      id: workflow_parameters
      env:
        SCHEMA: |-
          {
              "cache_ttl": {
                  "type": 11,
                  "prettyName": "Cache TTL",
                  "description": "The cache TTL set in hours to cache IOCs",
                  "uiPlaceholder": "24"
              }
          }
        VALUES: |-
          {
            "cache_ttl": 24
          }
      uuid: 66e433ac-0ea6-4524-91e1-c83d4c2ff150
      pretty_name: Workflow Parameters
      options:
        executor:
          name: utils_workflow_parameters_v_1_3_0
          env: {}
          sync: true
          disable: false
      manifestId: 30ebccc8-0ce8-5f13-960d-bc03b0179f53
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/utils/cryptographic_utils/calculate-sha1:2.0.0
      id: create_sha1_of_observable
      env:
        FILE: '{"source":"{{ $.event.file_hash }}","type":"default","torq_wrapper__":true}'
      uuid: 4c318d89-9d26-4fe1-a081-151915efdaba
      pretty_name: Create SHA1 of Observable
      options:
        executor:
          name: utils_infrastructure_v_1_12_0
          env:
            COMMAND: calculate_sha1
          sync: true
          disable: false
      manifestId: 3984d107-81b0-5b62-9868-e850cfb2ae77
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/torq/get-a-variable:8.1.0
      id: read_ioc_cache
      env:
        KEY: '{{ $.metadata.workflow_id }}_{{ $.create_sha1_of_observable.result }}'
      envFrom:
        integrationRef: '{{ $.event.torq_integration }}'
      uuid: ae9eb959-59f5-483f-8339-a02a03b4dd6f
      pretty_name: Read IOC Cache
      options:
        executor:
          name: http_request_v_4_6_0
          env:
            AUTHORIZATION: Bearer
            HEADERS: '{}'
            METHOD: GET
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["ACCESS_TOKEN", "KEY"]'
            TIMEOUT: "30"
            TOKEN: '{{ .ACCESS_TOKEN }}'
            URL: https://api.{{ .TORQ_BASE_URL }}/public/v2alpha/variables/{{ .KEY }}
          sync: true
          disable: false
      manifestId: 113df204-5b8d-5be4-8f22-895f9e87a732
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - if:
        conditions:
          or:
            - and:
                - lvalue: '{{ $.read_ioc_cache.api_object.value }}'
                  operator: IS_EMPTY
                  rvalue: ""
        then:
          - name: us-docker.pkg.dev/stackpulse/public/recorded_future/enrich-hash:3.0.4
            id: enrich_hash
            env:
              HASH_VALUE: '{{ $.event.file_hash }}'
              RETURN_FIELDS: enterpriseLists,entity,fileHashes,hashAlgorithm,intelCard,risk,riskMapping,sightings,timestamps
            envFrom:
              integrationRef: '{{ $.event.recorded_future_integration }}'
            ignoreFailure: true
            uuid: 2256f2d7-3564-4db2-aeff-17b990e96b85
            pretty_name: Enrich Hash
            options:
              executor:
                name: http_request_v_4_2_8
                env:
                  HEADERS: |-
                    {
                        "X-RFToken": "{{ .RECORDED_FUTURE_API_TOKEN }}"
                    }
                  METHOD: GET
                  PARSE_HJSON: "true"
                  REQUIRED_VARIABLES: '["RETURN_FIELDS", "HASH_VALUE", "RECORDED_FUTURE_API_TOKEN"]'
                  TIMEOUT: "30"
                  URL: https://api.recordedfuture.com/v2/hash/{{ .HASH_VALUE | urlEnc }}?&fields={{ .RETURN_FIELDS | urlEnc }}{{ if or .INCLUDE_METADATA }}&metadata={{ .INCLUDE_METADATA | urlEnc }}{{ end }}
                sync: true
                disable: false
            documentationUrl: https://api.recordedfuture.com/v2/#!/Hash/Hash_Lookup
            manifestId: 34ff6b3c-3591-4143-9f65-a8a76ee78017
            isPrivate: false
            mock_output:
              enabled: false
            skip: false
          - if:
              conditions:
                or:
                  - and:
                      - lvalue: '{{ $.enrich_hash.step_status.code }}'
                        operator: EQUALS
                        rvalue: "1"
              then:
                - parallel:
                    uuid: 1ae7b326-25e0-44e2-b94a-27667c956cac
                    pretty_name: Parallel Executions
                    threads:
                      - uuid: 4bb809e7-1119-49e9-b7fd-af1be2da029f
                        steps:
                          - if:
                              conditions:
                                or:
                                  - and:
                                      - lvalue: '{{ $.enrich_hash.api_object.data.riskMapping }}'
                                        operator: NOT_EMPTY
                                        rvalue: ""
                              then:
                                - name: us-docker.pkg.dev/stackpulse/public/jq/infra:3.8.0
                                  id: ttps
                                  env:
                                    INPUT: '{{ $.enrich_hash.api_object.data.riskMapping }}'
                                    JSON_QUERY: 'map ( {"rule":.rule, "ttps":(.categories[]|.name) } ) | group_by(.rule) | map({rule: .[0].rule, ttps: map(.ttps)})'
                                  uuid: 9d972a8a-699c-4bac-8700-dfd59005213d
                                  pretty_name: ttps
                                  options:
                                    executor:
                                      name: jq_infra_v_3_8_0
                                      env:
                                        COMMAND: jq_command
                                      sync: true
                                      disable: false
                                  documentationUrl: https://stedolan.github.io/jq/manual/#Basicfilters
                                  manifestId: 44e7e0f1-b7c5-5319-bbba-c53a2954c5c3
                                  isPrivate: false
                                  isPrivateUrl: true
                                  mock_output:
                                    enabled: false
                                  skip: false
                              else:
                                - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
                                  id: ttps
                                  env:
                                    DATA_TYPE: JSON
                                    VALUE_JSON: '[]'
                                    VARIABLE_NAME: output
                                  uuid: abac28e9-f44c-4ae6-9b12-8ff56b257352
                                  pretty_name: ttps
                                  options:
                                    executor:
                                      name: utils_infrastructure_v_1_9_0
                                      env:
                                        COMMAND: set_variable
                                      sync: true
                                      disable: false
                                  manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
                                  isPrivate: false
                                  mock_output:
                                    enabled: false
                                  skip: false
                              uuid: 98505073-e205-4f86-9edd-83909d8b4add
                              pretty_name: If Risk Mapping Found
                      - uuid: 27644468-b01d-45e9-b4c0-7eecf03ff425
                        steps:
                          - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
                            id: observable_subtype
                            env:
                              DATA_TYPE: string
                              VALUE_STRING: '{{ if eq $.enrich_hash.api_object.data.hashAlgorithm "SHA-256" }}SHA256{{ else }}{{ if eq $.enrich_hash.api_object.data.hashAlgorithm "SHA-1"}}SHA1{{else}}MD5{{ end }}{{ end }}'
                              VARIABLE_NAME: type
                            uuid: 96c72465-7fd6-4740-b3f0-b1e412458b1d
                            pretty_name: Observable Subtype
                            options:
                              executor:
                                name: utils_infrastructure_v_1_9_0
                                env:
                                  COMMAND: set_variable
                                sync: true
                                disable: false
                            manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
                            isPrivate: false
                            mock_output:
                              enabled: false
                            skip: false
                - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
                  id: enrichment_results
                  env:
                    DATA_TYPE: JSON
                    VALUE_JSON: |-
                      {
                        "raw_data":{{ $.enrich_hash.api_object.data }},
                        "observable_value":"{{ $.event.file_hash }}",
                        "observable_type":"File hash",
                        "observable_subtype":"{{ $.observable_subtype.type }}",
                        "observable_description":"{{ $.enrich_hash.api_object.data.risk.riskSummary }}",
                        "observable_reputation": "{{ $.enrich_hash.api_object.data.risk.criticalityLabel }}",
                        "filehashes":{{ $.enrich_hash.api_object.data.fileHashes }},
                        "mitre":{{ $.ttps.output }}
                      }
                    VARIABLE_NAME: output
                  uuid: 79ae49a6-3920-4642-9ec3-ae0b672a227d
                  pretty_name: Enrichment Results
                  options:
                    executor:
                      name: utils_infrastructure_v_1_9_0
                      env:
                        COMMAND: set_variable
                      sync: true
                      disable: false
                  manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
                  isPrivate: false
                  mock_output:
                    enabled: false
                  skip: false
                - name: us-docker.pkg.dev/stackpulse/public/torq/set-a-variable:8.1.0
                  id: save_the_ioc_details_to_cache
                  env:
                    EXPIRES_IN: '{{ $.workflow_parameters.cache_ttl }}h'
                    KEY: '{{ $.metadata.workflow_id }}_{{ $.create_sha1_of_observable.result }}'
                    VALUE: '{{ $.enrichment_results.output }}'
                  envFrom:
                    integrationRef: '{{ $.event.torq_integration }}'
                  uuid: 26ecaf71-9643-4379-9436-4bd152bd3044
                  pretty_name: Save the IOC details to Cache
                  options:
                    executor:
                      name: http_request_v_4_6_0
                      env:
                        AUTHORIZATION: Bearer
                        BODY: |-
                          {
                          {{ if or .EXPIRES_IN }}    "expires_in": "{{ .EXPIRES_IN | jsonEscape }}",{{ end }}
                          {{ if or .DO_NOT_RETURN_VALUE }}    "no_print": {{ .DO_NOT_RETURN_VALUE }},{{ end }}
                              "value": {{ .VALUE }}
                          }
                        CONTENT_TYPE: application/json
                        HEADERS: '{}'
                        METHOD: POST
                        PARSE_HJSON: "true"
                        REQUIRED_VARIABLES: '["ACCESS_TOKEN", "KEY", "VALUE"]'
                        TIMEOUT: "30"
                        TOKEN: '{{ .ACCESS_TOKEN }}'
                        URL: https://api.{{ .TORQ_BASE_URL }}/public/v2alpha/variables/{{ .KEY }}
                      sync: true
                      disable: false
                  manifestId: 0cd7861c-160a-5b92-9293-28d09953c01f
                  isPrivate: false
                  mock_output:
                    enabled: false
                  skip: false
              else:
                - exit:
                    success: "true"
                    pretty_name: Exit
                    output: |-
                      {
                        "output": {
                          "observable_value": "{{ $.event.file_hash }}",
                          "observable_reputation": "Not Found"
                        }
                      }
                    uuid: 493d1131-29f4-42e5-a993-3c04d18c7f93
                    use_schema: true
              uuid: 584a95fb-d164-465c-af65-1efacd408efe
              pretty_name: If RecordedFuture Analysis Exists
        else:
          - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
            id: enrichment_results
            env:
              DATA_TYPE: JSON
              VALUE_JSON: '{{ $.read_ioc_cache.api_object.value }}'
              VARIABLE_NAME: output
            uuid: e7709127-a700-4c3e-b5b0-98ff8616f61f
            pretty_name: Enrichment Results
            options:
              executor:
                name: utils_infrastructure_v_1_9_0
                env:
                  COMMAND: set_variable
                sync: true
                disable: false
            manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
            isPrivate: false
            mock_output:
              enabled: false
            skip: false
        uuid: a2fb6135-3fdb-4b1a-8d92-922abac995ad
        pretty_name: If IOC Cache is Empty
    - if:
        conditions:
          or:
            - and:
                - lvalue: '{{ $.event.provide_raw_analysis_data }}'
                  operator: EQUALS
                  rvalue: "true"
        then: []
        else:
          - name: us-docker.pkg.dev/stackpulse/public/jq/infra:3.8.0
            id: enrichment_results
            env:
              INPUT: '{{ $.enrichment_results.output }}'
              JSON_QUERY: del(.raw_data)
            uuid: 706cb2c3-b568-4d54-aefb-9bbbfa74fa2e
            pretty_name: Enrichment Results
            options:
              executor:
                name: jq_infra_v_3_8_0
                env:
                  COMMAND: jq_command
                sync: true
                disable: false
            documentationUrl: https://stedolan.github.io/jq/manual/#Basicfilters
            manifestId: 44e7e0f1-b7c5-5319-bbba-c53a2954c5c3
            isPrivate: false
            isPrivateUrl: true
            mock_output:
              enabled: false
            skip: false
        uuid: 8c2fd8c0-d7e7-487f-8766-27e855c1837c
        pretty_name: If Add Raw Analysis
    - exit:
        success: "true"
        pretty_name: Exit
        output: |-
          {
            "output": {{ $.enrichment_results.output }}
          }
        uuid: ecc8f92e-0223-4ac7-af49-846fe87c4add
        use_schema: true
  annotations:
    - uuid: efca92f8-fb2a-4a84-98a7-b3dfc32d3d25
      x: -612
      "y": 124
      width: 467
      height: 319
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"RecordedFuture - File Hash Enrichment"}]},{"type":"paragraph","content":[{"type":"hardBreak"},{"type":"text","text":"Receive a File Hash from a parent workflow and query Recorded Future for its reputation."}]},{"type":"paragraph","content":[{"type":"text","text":"This workflow utilizes a global variable as a cache to temporarily store results and actively queries for enrichment only when the observable reputation is not found in the local cache."}]},{"type":"paragraph","content":[{"type":"image","attrs":{"src":"https://images.g2crowd.com/uploads/product/image/social_landscape/social_landscape_9d79dbf9c1e656238aabcb6f6593e8b9/recorded-future.png","alt":null,"title":null}}]}]}'
    - uuid: dc3c820e-1b85-4c42-a3e3-8c041ff2fd08
      x: -186
      "y": 862
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Cached Results"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"By default results are cached 24 hrs."}]},{"type":"paragraph","content":[{"type":"text","text":"If reputation is found stored in a global value, then the cached result is returned to the parent workflow."}]}]}'
    - uuid: 5a5f539a-f4a5-4891-96d4-80db46f56d56
      x: 341
      "y": 211
      width: 438
      height: 151
      attachedStepId: 66e433ac-0ea6-4524-91e1-c83d4c2ff150
      attachedDistance:
        x: -341
        "y": -80
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Cache TTL"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"Set expiration time for local cache on "},{"type":"text","marks":[{"type":"code"}],"text":"Cache TTL"},{"type":"text","text":" variable"}]}]}'
    - uuid: 9f81550e-6302-451f-9945-4c4a1b511927
      x: 1161
      "y": 1689
      width: 422
      height: 253
      attachedStepId: 79ae49a6-3920-4642-9ec3-ae0b672a227d
      attachedDistance:
        x: -321
        "y": -91
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Results Summary"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"Output provides a summarized version of the analysis, although the original analysis information is available as optional."},{"type":"hardBreak"},{"type":"hardBreak"},{"type":"text","text":"All data is stored on local cache using the "},{"type":"text","marks":[{"type":"code"}],"text":"workflow_id"},{"type":"text","text":" and the "},{"type":"text","marks":[{"type":"code"}],"text":"hash of the observable"},{"type":"text","text":" value as the key for retrieve it later."}]}]}'
    - uuid: 2cc6ae97-9803-439a-8444-34950e5eb3b5
      x: 340
      "y": 2297
      width: 517
      height: 235
      attachedStepId: 706cb2c3-b568-4d54-aefb-9bbbfa74fa2e
      attachedDistance:
        x: -480
        "y": -57
      content: '{"type":"doc","content":[{"type":"heading","attrs":{"level":2},"content":[{"type":"text","text":"Provide Original Analysis Output"}]},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"When Provide "},{"type":"text","marks":[{"type":"code"}],"text":"Raw Analysis Data"},{"type":"text","text":" parameter is set to "},{"type":"text","marks":[{"type":"code"}],"text":"false"},{"type":"text","text":". Original JSON object returned by vendor API is deleted from output."}]},{"type":"paragraph","content":[{"type":"text","text":"When "},{"type":"text","marks":[{"type":"code"}],"text":"Provide Raw Analysis Data"},{"type":"text","text":" parameter is set to "},{"type":"text","marks":[{"type":"code"}],"text":"true"},{"type":"text","text":". Both, original API Response and Workflows Summary are returned to parent workflow."}]}]}'
  output_schema: |-
    {
        "output": {
            "type": 10,
            "prettyName": "output",
            "description": ""
        }
    }
root: true
