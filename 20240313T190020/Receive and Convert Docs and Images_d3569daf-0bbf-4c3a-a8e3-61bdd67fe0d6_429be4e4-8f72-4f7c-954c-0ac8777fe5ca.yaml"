apiVersion: torq.io/v2alpha
kind: Workflow
id: d3569daf-0bbf-4c3a-a8e3-61bdd67fe0d6
name: Receive and Convert Docs and Images
trigger:
  integrationTrigger:
    integration:
      name: pcwahook
      typeId: whatsapp_cloud_monitoring
    conditions:
      or:
        and:
          - expression:
              - lvalue: '{{ $.event.entry.0.changes.0.value.messages.0.type }}'
                operator: OPERATOR_EQUALS
                rvalue: document
playbook:
  steps:
    - name: us-docker.pkg.dev/stackpulse/public/utils/string_utils/replace-text:2.0.2
      id: number_fix
      env:
        INPUT: '{{ $.event.entry.0.changes.0.value.messages.0.from }}'
        INSTANCES: "1"
        NEW_TEXT: "52"
        OLD_TEXT: "521"
      uuid: ad3a541b-9a2b-4f38-9bef-e44fe6bb415b
      pretty_name: Number Fix
      options:
        executor:
          name: utils_infrastructure_v_1_3_39
          env:
            COMMAND: replace_text
          sync: true
          disable: false
      manifestId: 0fcc9b41-a46c-4405-923f-b5d30622a85d
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/utils/parameters_utils/workflow_parameters:1.3.0
      id: workflow_parameters
      env:
        SCHEMA: |-
          {
              "documents_mime_type": {
                  "type": 10,
                  "prettyName": "documents_mime_type",
                  "description": "",
                  "uiPlaceholder": ""
              },
              "labels": {
                  "type": 10,
                  "prettyName": "Labels",
                  "description": "",
                  "uiPlaceholder": ""
              }
          }
        VALUES: |-
          {
            "documents_mime_type": [
              "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
              "application/rtf"
            ],
            "labels": [
              "whatsapp-bot"
            ]
          }
      uuid: 4d696d70-16b8-413a-96d6-e8d83278aae7
      pretty_name: Workflow Parameters
      options:
        executor:
          name: utils_workflow_parameters_v_1_3_0
          env: {}
          sync: true
          disable: false
      manifestId: 30ebccc8-0ce8-5f13-960d-bc03b0179f53
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.3
      id: workflow_context
      env:
        DATA_TYPE: JSON
        VALUE_JSON: |-
          {
            "openai_integration":"openaijrp",
            "slack_integration":"wolken",
            "slack_channel":"whatsapp",
            "whatsapp_integration":"pcwa",
            "customer_phone_number": "{{ $.number_fix.result }}",
            "central_location":"19.558850755425006, -99.21671356946366"
          }
        VARIABLE_NAME: data
      uuid: 63eb0625-010d-4b84-a560-4d44ead254eb
      pretty_name: Workflow Context
      options:
        executor:
          name: utils_infrastructure_v_1_3_44
          env:
            COMMAND: set_variable
            SP_ENV_SCHEMA: '{"type": "object", "properties": {"DATA_TYPE": {"enum": ["boolean", "string", "JSON", "number"]}}, "required": ["VARIABLE_NAME", "DATA_TYPE"], "allOf": [{"if": {"properties": {"DATA_TYPE": {"const": "number"}}}, "then": {"required": ["VALUE_NUMBER"]}}, {"if": {"properties": {"DATA_TYPE": {"const": "boolean"}}}, "then": {"required": ["VALUE_BOOLEAN"]}}, {"if": {"properties": {"DATA_TYPE": {"const": "JSON"}}}, "then": {"required": ["VALUE_JSON"]}}]}'
          sync: true
          disable: false
      manifestId: aff12938-d053-4518-abc0-0a947c43da01
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/whatsapp/mark-message-as-read:1.0.0
      id: mark_message_as_read
      env:
        MESSAGE_ID: '{{ $.event.entry.0.changes.0.value.messages.0.id }}'
      envFrom:
        integrationRef: '{{ $.workflow_context.data.whatsapp_integration }}'
      uuid: 96fc9af7-7f46-4ce1-919c-ed63720fcf6b
      pretty_name: Mark Message as Read
      options:
        executor:
          name: http_request_v_4_2_11
          env:
            AUTHORIZATION: Bearer
            BODY: |-
              {
                "message_id": "{{ .MESSAGE_ID | jsonEscape }}",
                "messaging_product": "whatsapp",
                "status": "read"
              }
            CONTENT_TYPE: application/json
            HEADERS: '{}'
            METHOD: POST
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["MESSAGE_ID","FACEBOOK_ACCESS_TOKEN","WHATSAPP_PHONE_NUMBER_ID"]'
            TIMEOUT: "30"
            TOKEN: '{{ .FACEBOOK_ACCESS_TOKEN }}'
            URL: https://graph.facebook.com/v13.0/{{ .WHATSAPP_PHONE_NUMBER_ID | urlEnc }}/messages
          sync: true
          disable: false
      documentationUrl: https://developers.facebook.com/docs/whatsapp/cloud-api/guides/mark-message-as-read
      manifestId: eb08c6f7-3f74-4ab3-8f00-b1bfc92330b3
      isPrivate: false
      isPrivateUrl: true
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/http/request:4.9.1
      id: retrieve_media_url
      env:
        AUTHORIZATION: Bearer
        HEADERS: '{}'
        METHOD: GET
        TIMEOUT: "30"
        TOKEN: '{{ $.integrations.{{ $.workflow_context.data.whatsapp_integration }}.facebook_access_token }}'
        URL: https://graph.facebook.com/v13.0/{{ $.event.entry.0.changes.0.value.messages.0.document.id }}
      uuid: 835db19d-aa8a-4ed7-ae6b-0e682dc41d88
      pretty_name: Retrieve Media URL
      options:
        executor:
          name: http_request_v_4_9_1
          env:
            FAIL_ON_NON_SUCCESS_RESPONSE: "false"
            GO_TEMPLATE_BODY_PARSING: "false"
            RESPONSE_API_OBJECT_ONLY: "false"
          sync: true
          disable: false
      icon: https://cdn.torq.io/vendors/whatsapp.svg
      documentationUrl: https://developers.facebook.com/docs/whatsapp/cloud-api/guides/mark-message-as-read
      manifestId: 698c3c8e-2ca9-5803-9040-ffff0a5c74df
      isPrivate: false
      isPrivateUrl: true
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/scripting/python:3.2.0
      id: download_file_from_mediaurl
      env:
        PYTHON_CODE: "import json\nimport requests\nimport base64\n#encoded = base64.b64encode(b'data to be encoded')\n\nheaders = {'Authorization': f'Bearer {{ $.integrations.{{ $.workflow_context.data.whatsapp_integration }}.facebook_access_token }}'}\nresponse = requests.get(\"{{ $.retrieve_media_url.api_object.url }}\", headers=headers) \nencoded = base64.b64encode(response.content)\n\nprint(json.dumps({ \"file\": encoded.decode() }))\n#print(encoded.decode())"
      uuid: b1864a40-0707-4251-b53e-f85041e4b138
      pretty_name: Download File from MediaURL
      options: {}
      icon: https://storage.googleapis.com/stackpulse-public/vendors/python.svg
      manifestId: 3d8b3cda-d483-5117-a241-235e5c0bf281
      isPrivate: false
      isPrivateUrl: true
      mock_output:
        enabled: false
      skip: false
    - parallel:
        uuid: 133d47b0-47e7-4238-bc31-cd9a4ced241a
        pretty_name: Parallel Executions
        threads:
          - uuid: 61950f79-f99d-4dd6-8210-1259e160dba0
            steps:
              - name: us-docker.pkg.dev/stackpulse/public/slack/upload-file:2.0.0
                id: upload_original_file
                env:
                  CHANNEL_ID: '#dokx-inbox'
                  FILE_CONTENT: '{{ $.download_file_from_mediaurl.file}}'
                  FILE_NAME: '{{ $.event.entry.0.changes.0.value.messages.0.document.filename }}'
                envFrom:
                  integrationRef: wolken
                uuid: 5d5d199f-2733-4d5b-a89c-fef0842171e2
                pretty_name: Upload Original File
                options:
                  executor:
                    name: http_request_v_4_6_0
                    env:
                      BODY: '[{"key":"file","type":"file","value":"{{ .FILE_CONTENT | jsonEscape }}","filename":"{{ .FILE_NAME | jsonEscape }}"},{"key":"initial_comment","type":"text","value":"{{ .INITIAL_COMMENT | jsonEscape }}","should_exists_var":"INITIAL_COMMENT"},{"key":"channels","type":"text","value":"{{ .CHANNEL_ID | jsonEscape }}"},{"key":"thread_ts","type":"text","value":"{{ .THREAT_TS | jsonEscape }}","should_exists_var":"THREAT_TS"},{"key":"title","type":"text","value":"{{ .TITLE_OF_FILE | jsonEscape }}","should_exists_var":"TITLE_OF_FILE"}]'
                      CONTENT_TYPE: multipart/form-data; charset=utf-8
                      HEADERS: '{}'
                      METHOD: POST
                      PARSE_HJSON: "true"
                      REQUIRED_VARIABLES: '["FILE_CONTENT","FILE_NAME","CHANNEL_ID","apikey"]'
                      URL: https://slack.com/api/files.upload?token={{ .apikey | jsonEscape | rawB64Dec }}
                    sync: true
                    disable: false
                documentationUrl: https://api.slack.com/methods/files.upload
                manifestId: 29719e06-6886-5fdc-ab98-a478f4db35ab
                isPrivate: false
                isPrivateUrl: true
                mock_output:
                  enabled: false
                skip: false
          - uuid: d61cf8cd-9cd4-445d-8dc4-b1a8423d5a78
            steps:
              - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.1.6
                id: importquery
                env:
                  DATA_TYPE: string
                  VALUE_STRING: '{"query":"mutation ArtifactCreationMutation(\n  $file: Upload!\n  $x_opencti_description: String\n  $createdBy: String\n  $objectMarking: [String]\n  $objectLabel: [String]\n) {\n  artifactImport(file: $file, x_opencti_description: $x_opencti_description, createdBy: $createdBy, objectMarking: $objectMarking, objectLabel: $objectLabel) {\n    ...ArtifactLine_node\n    id\n  }\n}\n\nfragment ArtifactLine_node on Artifact {\n  id\n  entity_type\n  parent_types\n  observable_value\n  created_at\n  createdBy {\n    __typename\n    __isIdentity: __typename\n    id\n    name\n    entity_type\n  }\n  objectMarking {\n    edges {\n      node {\n        id\n        definition_type\n        definition\n        x_opencti_order\n        x_opencti_color\n      }\n    }\n  }\n  objectLabel {\n    edges {\n      node {\n        id\n        value\n        color\n      }\n    }\n  }\n  creators {\n    id\n    name\n  }\n  importFiles {\n    edges {\n      node {\n        id\n        name\n        size\n        metaData {\n          mimetype\n        }\n      }\n    }\n  }\n}\n","variables":{"file":null,"x_opencti_description":"ByTorq","createdBy":null,"objectMarking":[],"objectLabel":{{ $.workflow_parameters.labels}}'
                  VARIABLE_NAME: data
                uuid: bb0e1a14-dd04-4842-9344-711ce35ca367
                pretty_name: ImportQuery
                options:
                  executor:
                    name: utils_infrastructure_v_1_9_0
                    env:
                      COMMAND: set_variable
                    sync: true
                    disable: false
                manifestId: c7abdf70-5f5b-5cf4-8358-42bfd7b950ea
                isPrivate: false
                mock_output:
                  enabled: false
                skip: false
              - name: us-docker.pkg.dev/stackpulse/public/http/request:4.6.0
                id: import_artifact
                env:
                  AUTHORIZATION: Bearer
                  BODY: '[{"key":"operations","value":"{\"query\":\"mutation ArtifactCreationMutation(\\n  $file: Upload!\\n  $x_opencti_description: String\\n  $createdBy: String\\n  $objectMarking: [String]\\n  $objectLabel: [String]\\n) {\\n  artifactImport(file: $file, x_opencti_description: $x_opencti_description, createdBy: $createdBy, objectMarking: $objectMarking, objectLabel: $objectLabel) {\\n    ...ArtifactLine_node\\n    id\\n  }\\n}\\n\\nfragment ArtifactLine_node on Artifact {\\n  id\\n  entity_type\\n  parent_types\\n  observable_value\\n  created_at\\n  createdBy {\\n    __typename\\n    __isIdentity: __typename\\n    id\\n    name\\n    entity_type\\n  }\\n  objectMarking {\\n    edges {\\n      node {\\n        id\\n        definition_type\\n        definition\\n        x_opencti_order\\n        x_opencti_color\\n      }\\n    }\\n  }\\n  objectLabel {\\n    edges {\\n      node {\\n        id\\n        value\\n        color\\n      }\\n    }\\n  }\\n  creators {\\n    id\\n    name\\n  }\\n  importFiles {\\n    edges {\\n      node {\\n        id\\n        name\\n        size\\n        metaData {\\n          mimetype\\n        }\\n      }\\n    }\\n  }\\n}\\n\",\"variables\":{\"file\":null,\"x_opencti_description\":\"ByTorq\",\"createdBy\":null,\"objectMarking\":[],\"objectLabel\":[\"whatsapp-bot\"]}}","filename":"","type":"text"},{"key":"map","value":"{\"1\":[\"variables.file\"]}","filename":"","type":"text"},{"key":"1","value":"{{ $.download_file_from_mediaurl.file }}","filename":"{{ $.event.entry.0.changes.0.value.messages.0.document.filename }}","type":"file"}]'
                  CONTENT_TYPE: multipart/form-data; charset=utf-8
                  HEADERS: ""
                  METHOD: POST
                  TOKEN: 7ddd044f-1f25-408d-a6a0-058a72489b86
                  URL: https://novel-chow-oriented.ngrok-free.app/graphql
                uuid: b9cd4d79-f59a-40c9-b134-ad2bea27398c
                pretty_name: Import Artifact
                options:
                  executor:
                    name: http_request_v_4_6_0
                    env:
                      FAIL_ON_NON_SUCCESS_RESPONSE: "false"
                      GO_TEMPLATE_BODY_PARSING: "false"
                      RESPONSE_API_OBJECT_ONLY: "false"
                    sync: true
                    disable: false
                icon: https://svgshare.com/i/tYn.svg
                manifestId: 3dbe09b5-9f21-4ddc-bae8-a4aa025854fb
                isPrivate: false
                isPrivateUrl: true
                mock_output:
                  enabled: false
                skip: false
              - name: us-docker.pkg.dev/stackpulse/public/http/request:4.6.0
                id: import_artifact_2
                env:
                  AUTHORIZATION: Bearer
                  BODY: '[{"key":"operations","value":"{\"query\":\"mutation ArtifactCreationMutation(\\n  $file: Upload!\\n  $x_opencti_description: String\\n  $createdBy: String\\n  $objectMarking: [String]\\n  $objectLabel: [String]\\n) {\\n  artifactImport(file: $file, x_opencti_description: $x_opencti_description, createdBy: $createdBy, objectMarking: $objectMarking, objectLabel: $objectLabel) {\\n    ...ArtifactLine_node\\n    id\\n  }\\n}\\n\\nfragment ArtifactLine_node on Artifact {\\n  id\\n  entity_type\\n  parent_types\\n  observable_value\\n  created_at\\n  createdBy {\\n    __typename\\n    __isIdentity: __typename\\n    id\\n    name\\n    entity_type\\n  }\\n  objectMarking {\\n    edges {\\n      node {\\n        id\\n        definition_type\\n        definition\\n        x_opencti_order\\n        x_opencti_color\\n      }\\n    }\\n  }\\n  objectLabel {\\n    edges {\\n      node {\\n        id\\n        value\\n        color\\n      }\\n    }\\n  }\\n  creators {\\n    id\\n    name\\n  }\\n  importFiles {\\n    edges {\\n      node {\\n        id\\n        name\\n        size\\n        metaData {\\n          mimetype\\n        }\\n      }\\n    }\\n  }\\n}\\n\",\"variables\":{\"file\":null,\"x_opencti_description\":\"ByTorq\",\"createdBy\":null,\"objectMarking\":[],\"objectLabel\":[\"torq\"]}}","filename":"","type":"text"},{"key":"map","value":"{\"1\":[\"variables.file\"]}","filename":"","type":"text"},{"key":"1","value":"{{ $.download_file_from_mediaurl.file }}","filename":"{{ $.event.entry.0.changes.0.value.messages.0.document.filename }}","type":"file"}]'
                  CONTENT_TYPE: multipart/form-data; charset=utf-8
                  HEADERS: ""
                  METHOD: POST
                  TOKEN: 7ddd044f-1f25-408d-a6a0-058a72489b86
                  URL: https://novel-chow-oriented.ngrok-free.app/graphql
                uuid: 5a65a60a-0dbd-4e0b-a972-e2dfdfad917b
                pretty_name: Import Artifact 2
                options:
                  executor:
                    name: http_request_v_4_6_0
                    env:
                      FAIL_ON_NON_SUCCESS_RESPONSE: "false"
                      GO_TEMPLATE_BODY_PARSING: "false"
                      RESPONSE_API_OBJECT_ONLY: "false"
                    sync: true
                    disable: false
                icon: https://svgshare.com/i/tYn.svg
                manifestId: 3dbe09b5-9f21-4ddc-bae8-a4aa025854fb
                isPrivate: false
                isPrivateUrl: true
                mock_output:
                  enabled: false
                skip: true
              - name: us-docker.pkg.dev/stackpulse/public/http/request:4.6.0
                id: import_artifact_1
                env:
                  AUTHORIZATION: Bearer
                  BODY: '[{"key":"operations","value":"{\"query\":\"mutation ArtifactCreationMutation(\\n  $file: Upload!\\n  $x_opencti_description: String\\n  $createdBy: String\\n  $objectMarking: [String]\\n  $objectLabel: [String]\\n) {\\n  artifactImport(file: $file, x_opencti_description: $x_opencti_description, createdBy: $createdBy, objectMarking: $objectMarking, objectLabel: $objectLabel) {\\n    ...ArtifactLine_node\\n    id\\n  }\\n}\\n\\nfragment ArtifactLine_node on Artifact {\\n  id\\n  entity_type\\n  parent_types\\n  observable_value\\n  created_at\\n  createdBy {\\n    __typename\\n    __isIdentity: __typename\\n    id\\n    name\\n    entity_type\\n  }\\n  objectMarking {\\n    edges {\\n      node {\\n        id\\n        definition_type\\n        definition\\n        x_opencti_order\\n        x_opencti_color\\n      }\\n    }\\n  }\\n  objectLabel {\\n    edges {\\n      node {\\n        id\\n        value\\n        color\\n      }\\n    }\\n  }\\n  creators {\\n    id\\n    name\\n  }\\n  importFiles {\\n    edges {\\n      node {\\n        id\\n        name\\n        size\\n        metaData {\\n          mimetype\\n        }\\n      }\\n    }\\n  }\\n}\\n\",\"variables\":{\"file\":null,\"x_opencti_description\":\"ByTorq\",\"createdBy\":null,\"objectMarking\":[],\"objectLabel\":[\"torq\"]}}","filename":"","type":"text"},{"key":"map","value":"{\"1\":[\"variables.file\"]}","filename":"","type":"text"},{"key":"1","value":"{{ $.download_file_from_mediaurl.file }}","filename":"{{ jsonEscape $.event.filename }}","type":"file"}]'
                  CONTENT_TYPE: multipart/form-data; charset=utf-8
                  HEADERS: ""
                  METHOD: POST
                  TOKEN: '{{ $.integrations.localopencti.api_key }}'
                  URL: '{{ $.integrations.localopencti.management_url }}/graphql'
                uuid: f1e81a66-6bfe-485c-b6b5-99fe665a5f19
                pretty_name: Import Artifact 1
                options:
                  executor:
                    name: http_request_v_4_6_0
                    env:
                      FAIL_ON_NON_SUCCESS_RESPONSE: "false"
                      GO_TEMPLATE_BODY_PARSING: "false"
                      RESPONSE_API_OBJECT_ONLY: "false"
                    sync: true
                    disable: false
                icon: https://svgshare.com/i/tYn.svg
                manifestId: 3dbe09b5-9f21-4ddc-bae8-a4aa025854fb
                isPrivate: false
                isPrivateUrl: true
                mock_output:
                  enabled: false
                skip: true
    - switch:
        uuid: 81a2c9b4-244d-4125-9318-eb0fecd92449
        pretty_name: Switch
        cases:
          - id: 379c5863-b500-4174-82c4-2c9ee4ffde8d
            pretty_name: Documents to PDF
            conditions:
              or:
                - and:
                    - lvalue: '{{ $.event.entry.0.changes.0.value.messages.0.document.mime_type }}'
                      operator: IN
                      rvalue: '{{ $.workflow_parameters.documents_mime_type }}'
            steps:
              - name: us-docker.pkg.dev/stackpulse/public/http/request:4.9.1
                id: convert_to_pdf
                env:
                  AUTHORIZATION: None
                  BODY: '[{"key":"File","value":"{{ $.download_file_from_mediaurl.file }}","filename":"{{ $.event.entry.0.changes.0.value.messages.0.document.filename }}","type":"file"},{"key":"type","value":"{{ $.event.entry.0.changes.0.value.messages.0.document.mime_type }}","filename":"","type":"text"}]'
                  CONTENT_TYPE: multipart/form-data; charset=utf-8
                  HEADERS: '{}'
                  METHOD: POST
                  URL: https://v2.convertapi.com/convert/doc/to/pdf?Secret=KFkefGaZBQLHnYfz
                uuid: 11d5c5f8-91b5-49f4-a81e-a34fcb66aec1
                pretty_name: Convert to PDF
                options:
                  executor:
                    name: http_request_v_4_9_1
                    env:
                      FAIL_ON_NON_SUCCESS_RESPONSE: "false"
                      GO_TEMPLATE_BODY_PARSING: "false"
                      RESPONSE_API_OBJECT_ONLY: "false"
                    sync: true
                    disable: false
                manifestId: 698c3c8e-2ca9-5803-9040-ffff0a5c74df
                isPrivate: false
                isPrivateUrl: true
                mock_output:
                  enabled: false
                skip: false
              - name: us-docker.pkg.dev/stackpulse/public/slack/upload-file:2.0.0
                id: upload_pdf
                env:
                  CHANNEL_ID: '#dokx-inbox'
                  FILE_CONTENT: '{{ $.convert_to_pdf.api_object.Files.0.FileData }}'
                  FILE_NAME: '{{ $.convert_to_pdf.api_object.Files.0.FileName }}'
                envFrom:
                  integrationRef: wolken
                uuid: aeae1f4a-9f7a-4940-bda2-df98ae2e08f0
                pretty_name: Upload PDF
                options:
                  executor:
                    name: http_request_v_4_6_0
                    env:
                      BODY: '[{"key":"file","type":"file","value":"{{ .FILE_CONTENT | jsonEscape }}","filename":"{{ .FILE_NAME | jsonEscape }}"},{"key":"initial_comment","type":"text","value":"{{ .INITIAL_COMMENT | jsonEscape }}","should_exists_var":"INITIAL_COMMENT"},{"key":"channels","type":"text","value":"{{ .CHANNEL_ID | jsonEscape }}"},{"key":"thread_ts","type":"text","value":"{{ .THREAT_TS | jsonEscape }}","should_exists_var":"THREAT_TS"},{"key":"title","type":"text","value":"{{ .TITLE_OF_FILE | jsonEscape }}","should_exists_var":"TITLE_OF_FILE"}]'
                      CONTENT_TYPE: multipart/form-data; charset=utf-8
                      HEADERS: '{}'
                      METHOD: POST
                      PARSE_HJSON: "true"
                      REQUIRED_VARIABLES: '["FILE_CONTENT","FILE_NAME","CHANNEL_ID","apikey"]'
                      URL: https://slack.com/api/files.upload?token={{ .apikey | jsonEscape | rawB64Dec }}
                    sync: true
                    disable: false
                documentationUrl: https://api.slack.com/methods/files.upload
                manifestId: 29719e06-6886-5fdc-ab98-a478f4db35ab
                isPrivate: false
                isPrivateUrl: true
                mock_output:
                  enabled: false
                skip: false
        default:
          id: 7dc3c308-0fae-48ed-9b82-224af3c6addd
          steps: []
    - exit:
        success: "true"
        pretty_name: Exit
        output: '{}'
        uuid: 7b69d569-f92e-40fb-bea2-cfcd498998b6
    - name: us-docker.pkg.dev/stackpulse/public/http/request:4.6.0
      id: get_profile
      env:
        AUTHORIZATION: None
        HEADERS: ""
        METHOD: GET
        URL: '{{ $.ytdlp_wabot_02_download.fileurl }}.json'
      runner: vultrwarsaw
      ignoreFailure: true
      uuid: 0cc4b756-d32b-49c2-80f0-710e8d203d65
      pretty_name: Get Profile
      options:
        executor:
          name: http_request_v_4_6_0
          env:
            FAIL_ON_NON_SUCCESS_RESPONSE: "false"
            GO_TEMPLATE_BODY_PARSING: "false"
            RESPONSE_API_OBJECT_ONLY: "false"
          sync: true
          disable: false
      manifestId: 3dbe09b5-9f21-4ddc-bae8-a4aa025854fb
      isPrivate: false
      isPrivateUrl: true
      mock_output:
        enabled: false
      skip: true
    - name: us-docker.pkg.dev/stackpulse/public/whatsapp/send-text-message:1.0.0
      id: send_ack_message
      env:
        RECIPIENT_PHONE_NUMBER: '{{ $.workflow_context.data.customer_phone_number }}'
        TEXT: "\U0001F916 Fetching {{ $.media.type }} File for {{ $.download_link.url }}"
      envFrom:
        integrationRef: pcwa
      uuid: 0d5e1884-4782-4b9c-9ffc-61b148d00525
      pretty_name: Send ACK Message
      options:
        executor:
          name: http_request_v_4_0_2
          env:
            AUTHORIZATION: Bearer
            BODY: |-
              {
                  "messaging_product": "whatsapp",
                  "to": "{{ .RECIPIENT_PHONE_NUMBER | jsonEscape }}",
                  "type": "text",
                  "text": {
                      "body": "{{ .TEXT | jsonEscape }}"
                  }
              }
            CONTENT_TYPE: application/json
            HEADERS: '{}'
            METHOD: POST
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["WHATSAPP_PHONE_NUMBER_ID", "RECIPIENT_PHONE_NUMBER", "TEXT", "FACEBOOK_ACCESS_TOKEN"]'
            TIMEOUT: "30"
            TOKEN: '{{ .FACEBOOK_ACCESS_TOKEN }}'
            URL: https://graph.facebook.com/v13.0/{{ .WHATSAPP_PHONE_NUMBER_ID | urlEnc }}/messages
          sync: true
          disable: false
      documentationUrl: https://developers.facebook.com/docs/whatsapp/on-premises/reference/messages
      manifestId: e6b8c3f2-f1ef-4819-b636-9da658c3059b
      isPrivate: false
      mock_output:
        enabled: false
      skip: true
    - name: us-docker.pkg.dev/stackpulse/public/whatsapp/send-text-message:1.0.0
      id: send_link
      env:
        RECIPIENT_PHONE_NUMBER: '{{ $.workflow_context.data.customer_phone_number }}'
        TEXT: "\U0001F916 Enjoy! {{ $.ytdlp_wabot_02_download.result.media_url }}"
      envFrom:
        integrationRef: pcwa
      uuid: c48d537f-1cf7-4829-8fae-a32d4f3e1fcc
      pretty_name: Send Link
      options:
        executor:
          name: http_request_v_4_0_2
          env:
            AUTHORIZATION: Bearer
            BODY: |-
              {
                  "messaging_product": "whatsapp",
                  "to": "{{ .RECIPIENT_PHONE_NUMBER | jsonEscape }}",
                  "type": "text",
                  "text": {
                      "body": "{{ .TEXT | jsonEscape }}"
                  }
              }
            CONTENT_TYPE: application/json
            HEADERS: '{}'
            METHOD: POST
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["WHATSAPP_PHONE_NUMBER_ID", "RECIPIENT_PHONE_NUMBER", "TEXT", "FACEBOOK_ACCESS_TOKEN"]'
            TIMEOUT: "30"
            TOKEN: '{{ .FACEBOOK_ACCESS_TOKEN }}'
            URL: https://graph.facebook.com/v13.0/{{ .WHATSAPP_PHONE_NUMBER_ID | urlEnc }}/messages
          sync: true
          disable: false
      documentationUrl: https://developers.facebook.com/docs/whatsapp/on-premises/reference/messages
      manifestId: e6b8c3f2-f1ef-4819-b636-9da658c3059b
      isPrivate: false
      mock_output:
        enabled: false
      skip: true
    - name: us-docker.pkg.dev/stackpulse/public/whatsapp/send-image-message:1.0.0
      id: send_image_message
      env:
        IMAGE_URL: https://i.ibb.co/RzbhwQ2/Maldiciones-Para-Un-Mundo-En-Decadencia-Wrack-and-Ruin-Bonus.png
        RECIPIENT_PHONE_NUMBER: '{{ $.workflow_context.data.customer_phone_number }}'
      envFrom:
        integrationRef: pcwa
      ignoreFailure: true
      uuid: 32f54e16-b18c-4303-85e7-ba129730b87e
      pretty_name: Send Image Message
      options:
        executor:
          name: http_request_v_4_2_8
          env:
            AUTHORIZATION: Bearer
            BODY: |-
              {
                "image": {
                  "link": "{{ .IMAGE_URL | jsonEscape }}"
                },
                "messaging_product": "whatsapp",
                "to": "{{ .RECIPIENT_PHONE_NUMBER | jsonEscape }}",
                "type": "image"
              }
            CONTENT_TYPE: application/json
            HEADERS: ""
            METHOD: POST
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["WHATSAPP_PHONE_NUMBER_ID","IMAGE_URL","RECIPIENT_PHONE_NUMBER","FACEBOOK_ACCESS_TOKEN"]'
            TOKEN: '{{ .FACEBOOK_ACCESS_TOKEN }}'
            URL: https://graph.facebook.com/v13.0/{{ .WHATSAPP_PHONE_NUMBER_ID | urlEnc }}/messages
          sync: true
          disable: false
      documentationUrl: https://developers.facebook.com/docs/whatsapp/cloud-api/guides/send-messages#media-messages
      manifestId: 611a6bbe-a8c4-4e8d-95ce-b4e7c2501263
      isPrivate: false
      isPrivateUrl: true
      mock_output:
        enabled: false
      skip: true
    - name: us-docker.pkg.dev/stackpulse/public/whatsapp/send-text-message:1.0.0
      id: send_ack_message_1
      env:
        RECIPIENT_PHONE_NUMBER: '{{ $.workflow_context.data.customer_phone_number }}'
        TEXT: |-
          {{ $.get_profile.api_object.fulltitle }}
          {{ $.ytdlp_wabot_02_download.fileurl }}
      envFrom:
        integrationRef: pcwa
      ignoreFailure: true
      uuid: aa48590e-fcaf-4e03-a42f-dc052cef4fdb
      pretty_name: Send ACK Message 1
      options:
        executor:
          name: http_request_v_4_0_2
          env:
            AUTHORIZATION: Bearer
            BODY: |-
              {
                  "messaging_product": "whatsapp",
                  "to": "{{ .RECIPIENT_PHONE_NUMBER | jsonEscape }}",
                  "type": "text",
                  "text": {
                      "body": "{{ .TEXT | jsonEscape }}"
                  }
              }
            CONTENT_TYPE: application/json
            HEADERS: '{}'
            METHOD: POST
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["WHATSAPP_PHONE_NUMBER_ID", "RECIPIENT_PHONE_NUMBER", "TEXT", "FACEBOOK_ACCESS_TOKEN"]'
            TIMEOUT: "30"
            TOKEN: '{{ .FACEBOOK_ACCESS_TOKEN }}'
            URL: https://graph.facebook.com/v13.0/{{ .WHATSAPP_PHONE_NUMBER_ID | urlEnc }}/messages
          sync: true
          disable: false
      documentationUrl: https://developers.facebook.com/docs/whatsapp/on-premises/reference/messages
      manifestId: e6b8c3f2-f1ef-4819-b636-9da658c3059b
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/whatsapp/send-template-message:1.0.0
      id: send_template_message
      env:
        LANGUAGE_CODE: en_US
        RECIPIENT_PHONE_NUMBER: '{{ $.workflow_context.data.customer_phone_number }}'
        TEMPLATE_NAME: welcome_service_request
      envFrom:
        integrationRef: socialmanager_wolken
      uuid: a5e3ee9c-79c2-4afe-8a56-1e8db5e30b69
      pretty_name: Send Template Message
      options:
        executor:
          name: http_request_v_4_0_2
          env:
            AUTHORIZATION: Bearer
            BODY: |-
              {
                  "messaging_product": "whatsapp",
                  "to": "{{ .RECIPIENT_PHONE_NUMBER | jsonEscape }}",
                  "type": "template",
                  "template": {
                      "name": "{{ .TEMPLATE_NAME | jsonEscape }}",
                      "language": {
                          "code": "{{ .LANGUAGE_CODE | jsonEscape }}"
                      }
                  }
              }
            CONTENT_TYPE: application/json
            HEADERS: '{}'
            METHOD: POST
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["WHATSAPP_PHONE_NUMBER_ID", "RECIPIENT_PHONE_NUMBER", "TEMPLATE_NAME", "LANGUAGE_CODE", "FACEBOOK_ACCESS_TOKEN"]'
            TIMEOUT: "30"
            TOKEN: '{{ .FACEBOOK_ACCESS_TOKEN }}'
            URL: https://graph.facebook.com/v13.0/{{ .WHATSAPP_PHONE_NUMBER_ID | urlEnc }}/messages
          sync: true
          disable: false
      documentationUrl: https://developers.facebook.com/docs/whatsapp/on-premises/reference/messages
      manifestId: e363075e-094a-4918-908b-d5f33d9502be
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/http/request:4.2.11
      id: send_interactive_message
      env:
        AUTHORIZATION: Bearer
        BODY: "{\n  \"messaging_product\": \"whatsapp\",\n  \"recipient_type\": \"individual\",\n  \"to\" : \"{{ $.workflow_context.data.customer_phone_number }}\",\n  \"type\": \"interactive\", \n  \"interactive\":{\n  \"type\": \"list\",\n  \"header\": {\n    \"type\": \"text\",\n    \"text\": \"Fetch from YT\"\n  },\n  \"body\": {\n    \"text\": \"Choose the format for conversion.\"\n  },\n  \"footer\": {\n    \"text\": \"...\"\n  },\n  \"action\": {\n    \"button\": \"Opciones\",\n    \"sections\":[\n      {\n        \"title\":\"Audio Conversion\",\n        \"rows\": [\n          {\n            \"id\":\"audio_convert\",\n            \"title\": \"Audio\",\n            \"description\": \"Converto to mp3 file.\",           \n          }\n        ]\n      },\n      {\n        \"title\":\"Video Conversion\",\n        \"rows\": [\n          {\n            \"id\":\"video_convert\",\n            \"title\": \"Video\",\n            \"description\": \"Converto to mp4 file.\",           \n          }\n        ]\n      }\n    ]\n  }\n}\n}\n"
        CONTENT_TYPE: application/json
        HEADERS: '{}'
        METHOD: POST
        TIMEOUT: "30"
        TOKEN: '{{ $.integrations.''pcwa''.facebook_access_token }}'
        URL: https://graph.facebook.com/v13.0/{{ $.integrations.'pcwa'.phone_number_id }}/messages
      ignoreFailure: true
      uuid: 3e5352fb-d04b-443e-a37a-c0467aceb7a6
      pretty_name: Send Interactive Message
      options:
        executor:
          name: http_request_v_4_0_2
          env:
            FAIL_ON_NON_SUCCESS_RESPONSE: "false"
            GO_TEMPLATE_BODY_PARSING: "false"
            RESPONSE_API_OBJECT_ONLY: "false"
          sync: true
          disable: false
      icon: https://cdn.torq.io/vendors/whatsapp.svg
      documentationUrl: https://developers.facebook.com/docs/whatsapp/on-premises/reference/messages
      manifestId: 06ac64a3-0401-4f06-9270-6c63756a165b
      isPrivate: false
      isPrivateUrl: true
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/whatsapp/send-image-message:1.0.0
      id: send_image_message
      env:
        IMAGE_URL: '{{ $.create_static_map.api_object.url }}'
        RECIPIENT_PHONE_NUMBER: '{{ $.workflow_context.data.customer_phone_number }}'
      envFrom:
        integrationRef: '{{ $.workflow_context.data.whatsapp_integration }}'
      uuid: a3fb8e1e-83c5-4d73-8942-9be7f0bddeda
      pretty_name: Send Image Message
      options:
        executor:
          name: http_request_v_4_2_8
          env:
            AUTHORIZATION: Bearer
            BODY: |-
              {
                "image": {
                  "link": "{{ .IMAGE_URL | jsonEscape }}"
                },
                "messaging_product": "whatsapp",
                "to": "{{ .RECIPIENT_PHONE_NUMBER | jsonEscape }}",
                "type": "image"
              }
            CONTENT_TYPE: application/json
            HEADERS: ""
            METHOD: POST
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["WHATSAPP_PHONE_NUMBER_ID","IMAGE_URL","RECIPIENT_PHONE_NUMBER","FACEBOOK_ACCESS_TOKEN"]'
            TOKEN: '{{ .FACEBOOK_ACCESS_TOKEN }}'
            URL: https://graph.facebook.com/v13.0/{{ .WHATSAPP_PHONE_NUMBER_ID | urlEnc }}/messages
          sync: true
          disable: false
      documentationUrl: https://developers.facebook.com/docs/whatsapp/cloud-api/guides/send-messages#media-messages
      manifestId: 611a6bbe-a8c4-4e8d-95ce-b4e7c2501263
      isPrivate: false
      isPrivateUrl: true
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/whatsapp/send-text-message:1.0.0
      id: send_form_url_in_a_text_message
      env:
        RECIPIENT_PHONE_NUMBER: '{{ $.workflow_context.data.customer_phone_number }}'
        TEXT: '{{ $.metadata.form_url }}'
      envFrom:
        integrationRef: socialmanager_wolken
      uuid: 45adb9d0-96de-402d-b418-3be32f77ad2b
      pretty_name: Send Form URL in a Text message
      options:
        executor:
          name: http_request_v_4_0_2
          env:
            AUTHORIZATION: Bearer
            BODY: |-
              {
                  "messaging_product": "whatsapp",
                  "to": "{{ .RECIPIENT_PHONE_NUMBER | jsonEscape }}",
                  "type": "text",
                  "text": {
                      "body": "{{ .TEXT | jsonEscape }}"
                  }
              }
            CONTENT_TYPE: application/json
            HEADERS: '{}'
            METHOD: POST
            PARSE_HJSON: "true"
            REQUIRED_VARIABLES: '["WHATSAPP_PHONE_NUMBER_ID", "RECIPIENT_PHONE_NUMBER", "TEXT", "FACEBOOK_ACCESS_TOKEN"]'
            TIMEOUT: "30"
            TOKEN: '{{ .FACEBOOK_ACCESS_TOKEN }}'
            URL: https://graph.facebook.com/v13.0/{{ .WHATSAPP_PHONE_NUMBER_ID | urlEnc }}/messages
          sync: true
          disable: false
      documentationUrl: https://developers.facebook.com/docs/whatsapp/on-premises/reference/messages
      manifestId: e6b8c3f2-f1ef-4819-b636-9da658c3059b
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
    - name: us-docker.pkg.dev/stackpulse/public/http/request:4.2.11
      id: send_interactive_message_1
      env:
        AUTHORIZATION: Bearer
        BODY: |-
          {
              "messaging_product": "whatsapp",
              "text": {
                  "body": "{{ $.create_image.api_object.error.message }}"
              },
              "to": "{{ $.workflow_context.data.customer_phone_number }}",
              "type": "text"
          }
        CONTENT_TYPE: application/json
        HEADERS: '{}'
        METHOD: POST
        TIMEOUT: "30"
        TOKEN: '{{ $.integrations.''socialmanager_wolken''.facebook_access_token }}'
        URL: https://graph.facebook.com/v13.0/{{ $.integrations.'socialmanager_wolken'.phone_number_id }}/messages
      uuid: a0d4fafc-d85a-4366-88dd-457c166000ff
      pretty_name: Send Interactive Message 1
      options:
        executor:
          name: http_request_v_4_0_2
          env:
            FAIL_ON_NON_SUCCESS_RESPONSE: "false"
            GO_TEMPLATE_BODY_PARSING: "false"
            RESPONSE_API_OBJECT_ONLY: "false"
          sync: true
          disable: false
      icon: https://cdn.torq.io/vendors/whatsapp.svg
      documentationUrl: https://developers.facebook.com/docs/whatsapp/on-premises/reference/messages
      manifestId: 06ac64a3-0401-4f06-9270-6c63756a165b
      isPrivate: false
      isPrivateUrl: true
      mock_output:
        enabled: false
      skip: false
  annotations:
    - uuid: db1005d9-ceea-45e8-aee9-6a1090f25edd
      x: -387
      "y": 121
      content: '{"type":"doc","content":[{"type":"paragraph","content":[{"type":"text","text":"Receives a Document by WA and:"}]},{"type":"bulletList","content":[{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"Sends a copy to Slack"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"Converts to PDF"}]}]},{"type":"listItem","content":[{"type":"paragraph","content":[{"type":"text","text":"Adds to OpenCTI .... ???"}]}]}]}]}'
    - uuid: 5eb8da07-a532-4c58-8ca3-0907a05b0ae9
      x: 332
      "y": 1149
      content: '{"type":"doc","content":[{"type":"paragraph","content":[{"type":"text","text":"Add File into OpenCTI"}]}]}'
  output_schema: '{}'
root: true
