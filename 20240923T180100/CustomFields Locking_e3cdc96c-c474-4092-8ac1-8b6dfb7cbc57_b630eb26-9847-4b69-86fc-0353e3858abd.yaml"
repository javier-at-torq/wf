apiVersion: torq.io/v2alpha
kind: Workflow
id: e3cdc96c-c474-4092-8ac1-8b6dfb7cbc57
name: CustomFields Locking
trigger:
  internalEventTrigger:
    scenarioId: CUSTOM_FIELD_UPDATED
    conditions:
      or:
        and:
          - expression:
              - lvalue: '{{ $.event.operation }}'
                operator: OPERATOR_EQUALS
                rvalue: UPDATE
              - lvalue: '{{ $.event.triggered_by.kind }}'
                operator: OPERATOR_EQUALS
                rvalue: USER
playbook:
  steps:
    - name: us-docker.pkg.dev/stackpulse/public/utils/parameters_utils/workflow_parameters:1.3.0
      id: workflow_parameters
      env:
        SCHEMA: |-
          {
              "unlocked_fields": {
                  "type": 8,
                  "prettyName": "Unlocked Fields",
                  "description": "List of fields hat can be modified",
                  "uiPlaceholder": ""
              }
          }
        VALUES: |-
          {
            "unlocked_fields": "Verified Phishing,Classification"
          }
      uuid: 2d62c912-e46a-4014-a03e-1c672b61b0cc
      pretty_name: Workflow Parameters
      options:
        executor:
          name: utils_workflow_parameters_v_1_3_0
          env: {}
          sync: true
          disable: false
      manifestId: 30ebccc8-0ce8-5f13-960d-bc03b0179f53
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
      retry: {}
    - name: us-docker.pkg.dev/stackpulse/public/utils/string_utils/split-text:1.2.0
      id: unlocked_fields
      env:
        INPUT: '{{ $.workflow_parameters.unlocked_fields }}'
        SEPARATOR: ','
      uuid: 3ae9bee1-1f1f-4f5c-976e-847a2f2faf0e
      pretty_name: Unlocked Fields
      options:
        executor:
          name: utils_infrastructure_v_1_22_0
          env:
            COMMAND: split_text
          sync: true
          disable: false
      manifestId: bb040b2f-e192-5e37-8ab2-98b5bd3c1f91
      isPrivate: false
      mock_output:
        enabled: false
      skip: false
      retry: {}
    - if:
        conditions:
          or:
            - and:
                - lvalue: '{{ $.event.custom_fields.current.key }}'
                  operator: NOT_IN
                  rvalue: '{{ $.unlocked_fields.result }}'
        then:
          - parallel:
              uuid: 55510529-8613-446d-a779-a93a94f6c001
              pretty_name: Parallel Executions
              threads:
                - uuid: 8943ab00-e5a2-4103-b165-66631d0f366f
                  steps:
                    - if:
                        conditions:
                          or:
                            - and:
                                - lvalue: '{{ $.event.custom_fields.previous.value }}'
                                  operator: NOT_EQUALS
                                  rvalue: '{{ $.event.custom_fields.current.value }}'
                        then:
                          - name: us-docker.pkg.dev/stackpulse/public/torq_cases/set-custom-field-value:3.0.0
                            id: set_a_custom_field_s_value
                            env:
                              CASE_ID: '{{ $.event.custom_fields.current.case_id }}'
                              CUSTOM_FIELD_KEY: '{{ $.event.custom_fields.current.key }}'
                              CUSTOM_FIELD_VALUE: '{{ $.event.custom_fields.previous.value }}'
                              INPUT_MODE: single-field
                            uuid: 5a7d2a18-7432-42be-987f-c535438bbcc6
                            pretty_name: Set a custom field's value
                            options:
                              executor:
                                name: torq_cases_set-custom-field-value_v_3_0_0
                                env: {}
                                sync: true
                                disable: false
                            manifestId: 9990353f-b3d1-5104-8cc9-fd425163c069
                            isPrivate: false
                            mock_output:
                              enabled: false
                            skip: false
                            retry: {}
                        else: []
                        uuid: 454d2630-914a-4c8b-9d2c-c7453513d534
                        pretty_name: If CF Value changed
                - uuid: f151e8f3-8536-4dc4-9ee2-757873d8484d
                  steps:
                    - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.2.0
                      id: change
                      env:
                        DATA_TYPE: string
                        VALUE_STRING: '{{ $.event.triggered_by.user.email }}_{{ $.event.custom_fields.current.key }}_{{ $.event.custom_fields.current.case_id }}'
                        VARIABLE_NAME: id
                      uuid: 69b587e2-bef3-4d0b-a974-90f7540c276e
                      pretty_name: Change
                      options:
                        executor:
                          name: utils_infrastructure_v_1_22_0
                          env:
                            COMMAND: set_variable
                          sync: true
                          disable: false
                      manifestId: e430703a-6b6f-5114-9368-5e3fc166edb7
                      isPrivate: false
                      mock_output:
                        enabled: false
                      skip: false
                      retry: {}
                    - name: us-docker.pkg.dev/stackpulse/public/utils/cryptographic_utils/calculate-md5:3.2.0
                      id: calculate_md5
                      env:
                        __TQ_FILE_ENV_PARSER__FILE: plain-text
                        FILE: '{{ $.change.id }}'
                      uuid: 10f1259d-f5a6-4e49-92f6-063b03ae541d
                      pretty_name: Calculate MD5
                      options:
                        executor:
                          name: utils_infrastructure_v_1_22_0
                          env:
                            COMMAND: calculate_md5
                          sync: true
                          disable: false
                      manifestId: d5db3f0b-449d-52af-92f9-055c865a4b58
                      isPrivate: false
                      mock_output:
                        enabled: false
                      skip: false
                      retry: {}
                    - name: us-docker.pkg.dev/stackpulse/public/torq/get-a-variable:8.1.0
                      id: get_a_variable
                      env:
                        KEY: '{{ $.calculate_md5.result }}'
                      envFrom:
                        integrationRef: torq_api
                      uuid: d34bcd86-a403-48ad-8d4c-e27472c8d43e
                      pretty_name: Get a variable
                      options:
                        executor:
                          name: http_request_v_4_6_0
                          env:
                            AUTHORIZATION: Bearer
                            HEADERS: '{}'
                            METHOD: GET
                            PARSE_HJSON: "true"
                            REQUIRED_VARIABLES: '["ACCESS_TOKEN", "KEY"]'
                            TIMEOUT: "30"
                            TOKEN: '{{ .ACCESS_TOKEN }}'
                            URL: https://api.{{ .TORQ_BASE_URL }}/public/v2alpha/variables/{{ .KEY }}
                          sync: true
                          disable: false
                      manifestId: 113df204-5b8d-5be4-8f22-895f9e87a732
                      isPrivate: false
                      mock_output:
                        enabled: false
                      skip: false
                      retry: {}
                    - name: us-docker.pkg.dev/stackpulse/public/torq/set-a-variable:8.1.0
                      id: set_a_variable
                      env:
                        KEY: '{{ $.calculate_md5.result }}'
                        VALUE: '{{ add $.get_a_variable.api_object.value 1 }}'
                      envFrom:
                        integrationRef: torq_api
                      uuid: d31e7d71-985b-453a-b02c-0ed465b2f9cf
                      pretty_name: Set a variable
                      options:
                        executor:
                          name: http_request_v_4_6_0
                          env:
                            AUTHORIZATION: Bearer
                            BODY: |-
                              {
                              {{ if or .EXPIRES_IN }}    "expires_in": "{{ .EXPIRES_IN | jsonEscape }}",{{ end }}
                              {{ if or .DO_NOT_RETURN_VALUE }}    "no_print": {{ .DO_NOT_RETURN_VALUE }},{{ end }}
                                  "value": {{ .VALUE }}
                              }
                            CONTENT_TYPE: application/json
                            HEADERS: '{}'
                            METHOD: POST
                            PARSE_HJSON: "true"
                            REQUIRED_VARIABLES: '["ACCESS_TOKEN", "KEY", "VALUE"]'
                            TIMEOUT: "30"
                            TOKEN: '{{ .ACCESS_TOKEN }}'
                            URL: https://api.{{ .TORQ_BASE_URL }}/public/v2alpha/variables/{{ .KEY }}
                          sync: true
                          disable: false
                      manifestId: 0cd7861c-160a-5b92-9293-28d09953c01f
                      isPrivate: false
                      mock_output:
                        enabled: false
                      skip: false
                      retry: {}
                    - if:
                        conditions:
                          or:
                            - and:
                                - lvalue: '{{ $.set_a_variable.api_object.value }}'
                                  operator: GREATER_EQUAL
                                  rvalue: "3"
                        then:
                          - name: us-docker.pkg.dev/stackpulse/public/utils/output_utils/set-variable:2.2.0
                            id: note
                            env:
                              DATA_TYPE: string
                              VALUE_STRING: |-
                                Achtung!!!

                                User {{ $.event.triggered_by.user.email }} tried to manually modify custom field: `{{ $.event.custom_fields.current.key }}` up to {{ $.set_a_variable.api_object.value }} times on Case #{{ $.event.custom_fields.current.case_id }}.

                                New Value: {{ $.event.custom_fields.current.value }}
                              VARIABLE_NAME: text
                            uuid: da796704-cc6b-4e05-a7be-3bb3b8ea2b35
                            pretty_name: Note
                            options:
                              executor:
                                name: utils_infrastructure_v_1_22_0
                                env:
                                  COMMAND: set_variable
                                sync: true
                                disable: false
                            manifestId: e430703a-6b6f-5114-9368-5e3fc166edb7
                            isPrivate: false
                            mock_output:
                              enabled: false
                            skip: false
                            retry: {}
                          - name: us-docker.pkg.dev/stackpulse/public/torq/send-email:2.2.0
                            id: send_email
                            env:
                              BODY: |-
                                Achtung!!!

                                User {{ $.event.triggered_by.user.email }} tried to manually modify custom field: `{{ $.event.custom_fields.current.key }}` up to {{ $.set_a_variable.api_object.value }} times on Case #{{ $.event.custom_fields.current.case_id }}.

                                New Value: {{ $.event.custom_fields.current.value }}
                              BODY_TYPE: TEXT
                              RECIPIENTS: javier.reynapadilla@torq.io
                              SENDER_NAME: TorqWF
                              SUBJECT: Custom Field BruteForce
                            uuid: 798e5296-57d0-4796-ac19-f5f4735e0b6c
                            pretty_name: Send Email
                            options:
                              executor:
                                name: torq_send_email_v_2_2_0
                                env: {}
                                sync: true
                                disable: false
                            manifestId: cf6010b9-2e8b-56dd-9335-f5eb67be5e9a
                            isPrivate: false
                            mock_output:
                              enabled: false
                            skip: false
                            retry: {}
                          - name: us-docker.pkg.dev/stackpulse/public/interact/send_interaction:2.0.11
                            id: interaction
                            env:
                              CASE_ID: '{{ $.event.custom_fields.current.case_id }}'
                              FLOW_SETTINGS: '{"name":"Interaction Flow","openToOrgSso":false,"allowedToCancelExecution":false,"cancelExecutionWhenTimedOut":false}'
                              FORM_SCHEMA: '{ "parameters": [{"name":"parameter_1","type":"MARKDOWN_TEXT","prettyName":"Parameter 1","value":"### You can''t change this value manually. \n\nCustom Field `{{ jsonEscape $.event.custom_fields.current.key }}` is only changed by automation.","uploadedFile":{},"allowMultipleFiles":true,"selectDisplayMode":"DROPDOWN_DISPLAY"}, {"name":"user_action_button","type":"BUTTONS","buttons":[{"text":"OK"}]}]}'
                              FORM_TITLE: You can't change this value manually.
                              HAS_NEXT: "false"
                              TIMEOUT: 10m
                            uuid: 9de1690a-744d-4a39-aef8-4c8de6600bf5
                            pretty_name: Interaction
                            options:
                              executor:
                                name: interact_send_interaction_v_2_0_11
                                env: {}
                                sync: true
                                disable: false
                            manifestId: de441ab2-b89c-5601-80ea-1a2f117a1c1e
                            isPrivate: false
                            mock_output:
                              enabled: false
                            skip: false
                            retry: {}
                        else: []
                        uuid: 34f96448-431b-4d57-94b3-8d249d365a7f
                        pretty_name: If Over 3 changes
        else: []
        uuid: 5fc29434-0ba1-444b-a75e-f9949fdbcc8a
        pretty_name: If Field Locked
    - exit:
        success: "true"
        pretty_name: Exit
        output: '{}'
        uuid: aa7800b8-a056-4c10-a903-fbcc3e94f735
  output_schema: '{}'
root: true
